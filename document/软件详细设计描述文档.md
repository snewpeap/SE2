# 影院管理系统软件详细设计描述文档

## 修改记录

| 修改人员 |日期| 修改原因| 版本号 |
| :-: | :-: | - | :-: |
|  赖宝光、徐凌云、杨日东  | 2019/4/27 | 1. 填充标题及1~3部分内容 <br/> 2. 完成了userbl、moviebl、VIPcardbl的模块职责及模块内部类的接口规范 |  v0.1  |
|  杨日东、赖宝光  | 2019/4/28 | 1. 完成了cinemabl的模块职责和模块内部类的接口规范 <br/> 2. 修改了userbl和moviebl的接口规范 | v0.2 |
| 杨日东 | 2019/4/29 | 1.修改了cinemabl接口规范中部分接口的参数 | v0.2.1 |
| 赖宝光 | 2019/5/2 | 1.修改moviebl的模块职责及模块内部类的接口规范 | v0.2.2 |
| 魏进 | 2019/5/3 | 1.完成了salebl的模块内部类的接口规范 | v0.3 |
| 赖宝光、杨日东 | 2019/5/3 | 1.加上各模块的顺序图及部分状态图，完善依赖视角 <br/> 2.修改了cinemabl的接口规范| v0.3.1 |
|赖宝光，魏进|2019/5/4|1.加了salebl模块的状态图和模块职责 <br/> 2.修改了movie的部分接口规范|v0.3.2|
|赖宝光，杨日东，魏进|2019/5/4|1.更新了vipcard模块的顺序图及状态图 <br/> 2.加上目录|v1.0|
|赖宝光，杨日东，魏进，徐凌云|2019/6/21|完成第三阶段的提交|v2.0|

## 目录

- [影院管理系统软件详细设计描述文档](#影院管理系统软件详细设计描述文档)
    - [修改记录](#修改记录)
    - [目录](#目录)
    - [1 引言](#1-引言)
        - [1.1 编制目的](#11-编制目的)
        - [1.2 词汇表](#12-词汇表)
        - [1.3 参考资料](#13-参考资料)
    - [2 产品描述](#2-产品描述)
    - [3 系统结构设计概述](#3-系统结构设计概述)
    - [4 结构视角](#4-结构视角)
        - [4.1 业务逻辑层的分解](#41-业务逻辑层的分解)
            - [4.1.1 userbl模块](#411-userbl模块)
                - [4.1.1.1 模块概述](#4111-模块概述)
                - [4.1.1.2 整体结构](#4112-整体结构)
                - [4.1.1.3 模块内部类的接口规范](#4113-模块内部类的接口规范)
                - [4.1.1.4 业务逻辑层的动态模型](#4114-业务逻辑层的动态模型)
                - [4.1.1.5 业务逻辑层的设计原理](#4115-业务逻辑层的设计原理)
            - [4.1.2 moviebl模块](#412-moviebl模块)
                - [4.1.2.1 模块概述](#4121-模块概述)
                - [4.1.2.2 整体结构](#4122-整体结构)
                - [4.1.2.3 模块内部类的接口规范](#4123-模块内部类的接口规范)
                - [4.1.2.4 业务逻辑层的动态模型](#4124-业务逻辑层的动态模型)
                - [4.1.2.5 业务逻辑层的设计原理](#4125-业务逻辑层的设计原理)
            - [4.1.3 cinemabl模块](#413-cinemabl模块)
                - [4.1.3.1 模块概述](#4131-模块概述)
                - [4.1.3.2 整体结构](#4132-整体结构)
                - [4.1.3.3 模块内部类的接口规范](#4133-模块内部类的接口规范)
                - [4.1.3.4 业务逻辑层的动态模型](#4134-业务逻辑层的动态模型)
                - [4.1.3.5 业务逻辑层的设计原理](#4135-业务逻辑层的设计原理)
            - [4.1.4 VIPcardbl模块](#414-vipcardbl模块)
                - [4.1.4.1 模块概述](#4141-模块概述)
                - [4.1.4.2 整体结构](#4142-整体结构)
                - [4.1.4.3 模块内部类的接口规范](#4143-模块内部类的接口规范)
                - [4.1.4.4 业务逻辑层的动态模型](#4144-业务逻辑层的动态模型)
                - [4.1.4.5 业务逻辑层的设计原理](#4145-业务逻辑层的设计原理)
            - [4.1.5 salebl模块](#415-salebl模块)
                - [4.1.5.1 模块概述](#4151-模块概述)
                - [4.1.5.2 整体结构](#4152-整体结构)
                - [4.1.5.3 模块内部类的接口规范](#4153-模块内部类的接口规范)
                - [4.1.5.4 业务逻辑层的动态模型](#4154-业务逻辑层的动态模型)
                - [4.1.5.5 业务逻辑层的设计原理](#4155-业务逻辑层的设计原理)
            - [4.1.6 statisticsbl模块](#416-statisticsbl模块)
                - [4.1.6.1 模块概述](#4161-模块概述)
                - [4.1.6.2 整体结构](#4162-整体结构)
            - [4.1.6.3 模块内部类的接口规范](#4163-模块内部类的接口规范)
        - [4.2 数据层的分解](#42-数据层的分解)
            - [4.2.1 userdataservice 模块](#421-userdataservice-模块)
                - [4.2.1.1 模块概述](#4211-模块概述)
                - [4.2.1.2 模块内部类的接口规范](#4212-模块内部类的接口规范)
            - [4.2.2 moviedataservice 模块](#422-moviedataservice-模块)
                - [4.2.2.1 模块概述](#4221-模块概述)
                - [4.2.2.2 模块内部类的接口规范](#4222-模块内部类的接口规范)
            - [4.2.3 cinemadataservice 模块](#423-cinemadataservice-模块)
                - [4.2.3.1 模块概述](#4231-模块概述)
                - [4.2.3.2 模块内部类的接口规范](#4232-模块内部类的接口规范)
            - [4.2.4 vipdataservice 模块](#424-vipdataservice-模块)
                - [4.2.4.1 模块概述](#4241-模块概述)
                - [4.2.4.2 模块内部类的接口规范](#4242-模块内部类的接口规范)
            - [4.2.5 saledataservice 模块](#425-saledataservice-模块)
                - [4.2.5.1 模块概述](#4251-模块概述)
                - [4.2.5.2 模块内部类的接口规范](#4252-模块内部类的接口规范)
        - [4.3 展示层的分解](#43-展示层的分解)
            - [4.3.1 展示层的接口规范](#431-展示层的接口规范)
    - [5 依赖视角](#5-依赖视角)


## 1 引言

### 1.1 编制目的

本报告详细完成对连续商店管理系统的详细设计，达到指导后续软件构造的目的，同时实现和测试人员及用户的沟通。

本报告面向开发人员、测试人员及最终用户而编写，是了解系统的导航。

### 1.2 词汇表

| 词汇名称 | 词汇含义 | 备注  |
| :-: | :-: | :-: |
|bl|业务逻辑(Business logic)||
|vo|值对象(Value object)||
|po|持久对象(Persistence object)|

### 1.3 参考资料

- 影院管理系统用例描述文档
- 影院管理系统软件需求规格说明文档
- 影院管理系统体系结构设计描述文档

## 2 产品描述

参考影院管理系统用例文档和影院管理系统软件需求规格说明文档中对产品的概括描述。

## 3 系统结构设计概述

参考影院管理系统体系结构设计描述文档中对体系结构设计的概述。









## 4 结构视角

### 4.1 业务逻辑层的分解

业务逻辑层的开发包图参见软件体系结构文档图

#### 4.1.1 userbl模块

##### 4.1.1.1 模块概述

userbl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。
userbl模块的职责及接口参见软件系统结构描述文档。

##### 4.1.1.2 整体结构

根据体系结构的设计，我们将系统分为展示层，业务逻辑层，数据层。每一层之间为了增加灵活性，我们会添加接口。比如展示层和业务逻辑层之间，我们添加blservices.user.AccountService和blservices.user.StaffManagement接口。业务逻辑层和数据层之间添加dataservice.user.UserMapper,dataservice.user.RoleMapper,dataservice.user.UserHasRoleMapper接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了AccountController和StaffManagementController。

- userbl模块的设计如图所示。

![userbl模块各个类的设计](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/userbl_detailed_class_diagram.png)

- 表1 userbl模块各个类的职责

| 模块| 职责|
| - | - |
| AccountController | 负责接受展示层传递的用户账户相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层 |
| StaffManagementController | 负责接受展示层传递的员工账户管理相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层 |
| AccountService | 账户相关的业务逻辑服务接口，可以解决登录、注册和给予其他业务逻辑需要的用户信息的问题 |
| StaffManagement | 员工管理的业务逻辑服务接口，可以解决员工的增删改查和给予其他业务逻辑需要的员工信息的问题 |
| AccountImpl | AccountService的一般实现类 |
| StaffManagementImpl | StaffManagement的一般实现类 |

##### 4.1.1.3 模块内部类的接口规范

- 表2 AccountController的接口规范

| 提供的服务（供接口）  |||
| - | - | - |
| AccountController.login  | 语法| ```public Response login(UserForm userForm)```|
|| 前置条件 | 用户未登录 |
|| 后置条件 | 返回登录验证的结果到展示层，创建会话，跳转到登陆后界面 |
| AccountController.register | 语法| ```public Response register(RegistryForm registryForm)```  |
|| 前置条件 | 无 |
|| 后置条件 | 返回注册的结果到展示层 |
| AccountController.logout | 语法| ```public Response logout()```|
|| 前置条件 | 用户已登录|
|| 后置条件 | 删除用户本次登录会话，返回登出的结果，跳转到登录界面|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
| ```AccountService.login(UserForm userForm)```| 用户登录的检验|
| ```AccountService.register(RegistryForm registryForm)``` | 用户注册的检验和完成 |

- 表3 AccountService的接口规范

| 提供的服务（供接口） |||
| - | - | - |
| AccountService.login| 语法| ```public Response login(UserForm userForm)```|
|| 前置条件 | user中的信息符合规范|
|| 后置条件 | 返回登录成功的用户UserVO，若登陆失败，则返回错误信息 |
| AccountService.register| 语法| ```public Response register(RegistryForm registryForm)```|
|| 前置条件 | newUser中的信息符合规范|
|| 后置条件 | 返回注册成功的用户UserVO，若注册失败，则返回错误信息|
| AccountService.getUserByUserID | 语法| ```public UserVO getUserByUserID(int userID)```|
|| 前置条件 | 无|
|| 后置条件 | 返回具有此ID的UserVO对象（可能为空值）|
|AccountService.getUserVOByName|语法|```public UserVO getUserVOByName(String name)```|
||前置条件|无|
||后置条件|返回此名字的UserVO|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
|```UserMapper.selectByPrimaryKey(Integer id)```|根据id获得相应的用户对象|
|```UserMapper.insertSelective(User record)```|在数据库中插入一个用户对象|
|```UserMapper.selectByName(String name)```|根据用户名获得相应的用户对象|

- 表4 StaffManagementController的接口规范

| 提供的服务（供接口） |||
| - | - | - |
|StaffManagementController.getStaff|语法|```public Response getStaff(@RequestParam List<String> query)```|
||前置条件|请求者是管理员|
||后置条件|返回查询的结果到展示层|
|StaffManagementController.addStaff|语法|```public Response addStaff(@RequestBody StaffForm staffForm)```|
||前置条件|请求者是管理员|
||后置条件|返回添加员工的结果到展示层|
|StaffManagementController.addManager|语法|```public Response addManager(@RequestBody StaffForm staffForm)```|
||前置条件|请求者是管理员|
||后置条件|返回添加管理员的结果到展示层|
|StaffManagementController.changeRole|语法|```public Response changeRole(@RequestBody StaffForm staffForm)```|
||前置条件|请求者是管理员，员工存在|
||后置条件|返回更改员工角色的结果到展示层|
|StaffManagementController.removeStaff|语法|```public Response removeStaff(@RequestParam int staffId)```|
||前置条件|请求者是管理员，员工存在|
||后置条件|返回是否删除成功|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
|```StaffManagement.getStaff(List<String> query)```|获得查询的员工|
|```StaffManagement.addStaff(StaffForm staffForm)```|添加一个员工|
|```StaffManagement.addManager(StaffForm staffForm)```|添加一个管理员|
|```StaffManagement.changeRole(StaffForm staffForm)```|改变一个员工的角色|

- 表5 StaffManagement的接口规范

| 提供的服务（供接口） |||
| - | - | - |
|StaffManagement.getStaff|语法|```public Response getStaff(List<String> query)```|
||前置条件|无|
||后置条件|返回含有员工列表的vo.Response|
|StaffManagement.addStaff|语法|```public Response addStaff(StaffForm staffForm)```|
||前置条件|无|
||后置条件|返回添加的员工信息|
|StaffManagement.addManager|语法|```public Response addManager(StaffForm staffForm)```|
||前置条件|无|
||后置条件|返回添加的经理信息|
|StaffManagement.changeRole|语法|```public Response changeRole(StaffForm staffForm)```|
||前置条件|无|
||后置条件|返回修改角色后的员工信息|
|StaffManagement.removeStaff|语法|```Response removeStaff(int staffID)```|
||前置条件|无|
||后置条件|返回删除员工是否成功|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
|```UserMapper.selectByPrimaryKey(Integer id)```|根据id获得相应的用户对象|
|```UserMapper.insertSelective(User record)```|在数据库中插入一个用户对象|
|```UserMapper.deleteByPrimaryKey(Integer id)```|在数据库中删除一个用户对象|
|```UserMapper.updateByPrimaryKeySelective(User record)```|在数据库中修改一个用户对象|
|```UserMapper.selectByName(String name)```|根据用户名获得相应的用户对象|
|```UserMapper.selectAllStaff()```|获得所有员工对象|
|```UserMapper.selectAllManager()```|获得所有经理对象|
|```UserMapper.selectStaffByName(String name)```|根据用户名获得一个员工对象|
|```UserMapper.selectManagerByName(String name)```|根据用户名获得一个经理对象|
|```RoleMapper.deleteByPrimaryKey(Integer id)```|删除一个角色对象|
|```RoleMapper.insertSelective(Role record)```|插入一个角色对象|
|```RoleMapper.selectByPrimaryKey(Integer id)```|获得一个角色对象|
|```RoleMapper.selectRoleByName(String roleName)```|根据角色名字一个角色对象|
|```RoleMapper.updateByPrimaryKeySelective(Role record)```|修改一个角色对象|
|```UserHasRoleMapper.insertSelective(UserHasRoleKey record)```|给用户添加角色|
|```UserHasRoleMapper.deleteByUserID(int userID)```|删除用户的角色|
|```UserHasRoleMapper.updateByUserID(UserHasRoleKey record)```|修改用户的角色|
|```UserHasRoleMapper.selectByUserID(int userID)```|获得用户的角色|

##### 4.1.1.4 业务逻辑层的动态模型

- 下图表示了用户登录时，用户业务逻辑处理的相关对象之间的协作。

![用户登录的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/userbl_sd_login.png?raw=true)

- 下图表示了用户注册时，用户业务逻辑处理的相关对象之间的协作。

![用户注册的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/userbl_sd_signup.png?raw=true)

- 下图表示了用户登出时，用户业务逻辑处理的相关对象之间的协作。

![用户登出的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/userbl_sd_logout.png?raw=true)

##### 4.1.1.5 业务逻辑层的设计原理

利用委托式控制风格，每个界面需要的业务逻辑由各自的控制器委托给不同的业务逻辑对象。

#### 4.1.2 moviebl模块

##### 4.1.2.1 模块概述

moviebl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。
moviebl模块的职责及接口参见软件系统结构描述文档。

##### 4.1.2.2 整体结构

根据体系结构的设计，我们将系统分为展示层，业务逻辑层，数据层。每一层之间为了增加灵活性，我们会添加接口。比如展示层和业务逻辑层之间，我们添加blservices.movie.MovieService，blservices.movie.MovieManagement，blservices.movie.MovieLikeService接口。业务逻辑层和数据层之间添加dataservice.movie.MovieMapper和dataservice.movie.MovieLikeMapper接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了MovieController，这样MovieController会将对用户的业务逻辑处理委托给业务逻辑对象。ArrangementInfo,PromotionInfo,StatisticsInfo是根据依赖倒置原则，为了消除循环依赖而产生的接口。

- moviebl模块的设计如图所示。

![moviebl模块各个类的设计](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/moviebl_detailed_class_diagram.png)

- 表6 moviebl模块各个类的职责

| 模块| 职责|
| - | - |
| MovieController | 负责接受展示层传递的电影查询、管理、想看操作相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层 |
| MovieService | 电影的业务逻辑服务接口，可以解决搜索电影、查看电影详情和给予其他业务逻辑需要的电影信息的问题 |
| MovieLikeService | 电影想看操作的业务逻辑服务接口，可以解决想看、取消想看电影，电影想看数据和给予其他业务逻辑需要的电影想看记录信息的问题 |
| MovieManagement | 电影管理的业务逻辑服务接口，可以解决电影管理的问题 |
| ArrangementInfo | 排片业务逻辑服务的依赖倒置接口，解决下架或修改电影时需要的电影排片信息问题 |
| PromotionInfo | 优惠活动业务逻辑服务的依赖倒置接口，解决获得电影参与的优惠活动的问题 |
| StatisticsInfo | 统计业务逻辑服务的依赖倒置接口，解决获得电影热度值的问题 |
| MovieServiceImpl | MovieService的一般实现类 |
| MovieLikeServiceImpl | MovieLikeService的一般实现类 |
| MovieManagement | MovieManagement的一般实现类 |

##### 4.1.2.3 模块内部类的接口规范

- 表7 MovieController的接口规范
  
| 提供的服务（供接口)|||
| - | - | - |
| MovieController.getMovieList | 语法| ```public Response getAllMovie()```|
|| 前置条件 | 已创建一个Movie业务逻辑对象，且发起请求的用户已登录|
|| 后置条件 | 返回所有已上架电影|
| MovieController.getOneMovie| 语法| ```public Response getOneMovie(@PathVariable int movieId, int userID)```|
|| 前置条件 | 已创建一个Movie业务逻辑对象，且发起请求的用户已登录|
|| 后置条件 | 返回该部电影详情|
| MovieController.like| 语法| ```public Response likeMovie(@PathVariable int movieId, int userID)```|
|| 前置条件 | 已创建一个Movie业务逻辑对象，且发起请求的用户已登录|
|| 后置条件 | 返回标记电影为想看的结果|
| MovieController.unlike| 语法| ```public Response unlikeMovie(@PathVariable int movieId, int userID)```  |
|| 前置条件 | 已创建一个Movie业务逻辑对象，且发起请求的用户已登录|
|| 后置条件 | 返回取消标记想看电影的结果|
| MovieController.search| 语法| ```public Response searchMovies(@RequestParam String query, int userID)```|
|| 前置条件 | 已创建一个Movie业务逻辑对象，且输入符合规则，且发起请求的用户已登录|
|| 后置条件 | 返回搜索到的电影|
| MovieController.addMovie | 语法| ```public Response addMovie(@RequestBody MovieForm movieForm)```|
|| 前置条件 | 请求上架电影的已登录用户具有相应的权限，已创建一个Movie业务逻辑对象，输入符合规则|
|| 后置条件 | 返回上架电影的结果|
|MovieController.modifyMovie|语法|```public Response modifyMovie(@RequestBody MovieForm movieForm)```|
||前置条件|请求修改电影的已登录用户具有相应的权限，已创建一个Movie业务逻辑对象，输入符合规则|
||后置条件|返回修改电影详情的结果|
|MovieController.removeMovie|语法|```public Response withdrawMovie(@RequestParam int movieId)```|
||前置条件|请求下架电影的已登录用户具有相应的权限，已创建一个Movie业务逻辑对象|
||后置条件|返回下架电影的结果|
|MovieController.adminGetAllMovie|语法|```public Response adminGetAllMovie()```|
||前置条件|请求电影信息的用户登陆的身份是管理员|
||后置条件|返回管理员视角可见的全部电影|
|MovieController.adminGetOneMovie|语法|```public Response adminGetOneMovie(@PathVariable int movieId)```|
||前置条件|已创建一个Movie业务逻辑对象，且输入符合规则，请求电影信息的用户登陆的身份是管理员|
||后置条件|返回对应ID电影的管理员视角信息|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
|```MovieService.getMovie(int movieID, int userID)```|根据电影id获取电影|
|```MovieService.searchMovies(String query,int userID)```|根绝查询字符串查询电影|
|```MovieLikeService.like(int userID, int movieID)```|将用户对某部电影的想看状态标记为想看|
|```MovieLikeService.unlike(int userID, int movieID)```|将用户对某部电影的想看状态取消|
|```MovieManagement.addMovie(MovieForm movieForm)```|上架一部电影|
|```MovieManagement.modifyMovie(MovieForm movieForm)```|修改一部电影的信息|
|```MovieManagement.removeMovie(int movieID)```|下架一部电影|
|```MovieManagement.getMovie(int movieID)```|获取一部电影的高权限信息|

- 表8 MovieService的接口规范

| 提供的服务（供接口) |||
| - | - | - |
|MovieService.getMovie|语法|```public Response getMovie(int movieID, int userID)```|
||前置条件|用户请求查询电影|
||后置条件|系统返回相应的电影或者所有电影，电影里包含了用户是否想看该电影的信息|
|MovieService.searchMovies|语法|```public Response searchMovies(String query,int userID)```|
||前置条件|用户请求搜索电影|
||后置条件|系统返回符合条件的电影|
|MovieService.getMovieNameByID|语法|```String getMovieNameByID(int movieID)```|
||前置条件|无|
||后置条件|系统返回对应序号电影的名字|
|MovieService.getReleaseTimeByID|语法|```Date getReleaseTimeByID(int movieID)```|
||前置条件|无|
||后置条件|系统返回对应序号电影的上映时间|
|MovieService.getMoviePOByID|语法|```Movie getMoviePOByID(int movieID)```|
||前置条件|无|
||后置条件|系统返回对应序号电影的PO|
|MovieService.getDurationTimeByID|语法|```int getDurationTimeByID(int movieID)```|
||前置条件|无|
||后置条件|系统返回对应序号电影的时长|

| 需要的服务（需接口）||
| - | - |
| 服务名| 服务|
|```Movie selectByPrimaryKey(Integer id)```|获得一条记录|
|```MovieMapper.selectAll()```|获得所有记录|
|```MovieMapper.query(String query)```|查询一条记录|

- 表9 MovieManagement的接口规范

|提供的服务（供接口）|||
|-|-|-|
|MovieManagement.addMovie|语法|```public Response addMovie(MovieForm movieForm)```|
||前置条件|用户请求上架电影|
||后置条件|系统返回上架结果|
|MovieManagement.modifyMovie|语法|```public Response modifyMovie(MovieForm movieForm)```|
||前置条件|用户请求修改电影|
||后置条件|系统返回修改结果|
|MovieManagement.removeMovie|语法|```public Response removeMovie(int movieID)```|
||前置条件|用户请求下架电影|
||后置条件|系统返回下架结果|
|MovieManagement.getMovie|语法|```public Response getMovie(int movieID)```|
||前置条件|用户请求查询电影|
||后置条件|系统返回该电影或全部电影|
|MovieManagement.getReleaseMovies|语法|```List<Movie> getReleasedMovies()```|
||前置条件|无|
||后置条件|系统返回所有已上映和已下架的电影|
|MovieManagement.getMovieByID|语法|```Movie getMovieByID(int movieID)```|
||前置条件|无|
||后置条件|系统返回对应ID的电影|

| 需要的服务（需接口）||
| - | - |
| 服务名| 服务|
|```MovieMapper.insertSelective(Movie record)```|插入一条记录|
|```MovieMapper.deleteByPrimaryKey(Integer id)```|删除一条记录|
|```MovieMapper.updateByPrimaryKeySelective(Movie record)```|修改一条记录|
|```MovieMapper.selectByPrimaryKey(Integer id)```|获得一条记录|
|```MovieMapper.selectAll()```|获得所有记录|
|```MovieMapper.query(String query)```|查询一条电影记录|

- 表10 MovieLikeService的接口规范

|提供的服务（供接口）|||
|-|-|-|
|MovieLikeService.like|语法|```public Response like(int userID, int movieID)```|
||前置条件|用户请求标记电影为想看|
||后置条件|系统返回标记结果|
|MovieLikeService.unlike|语法|```public Response unlike(int userID, int movieID)```|
||前置条件|用户请求取消标记想看电影|
||后置条件|系统返回取消结果|
|MovieLikeService.getLikeAmount|语法|```int getLikeAmount(int movieID)```|
||前置条件|无|
||后置条件|系统返回对应电影的想看人数|
|MovieLikeService.getIsLike|语法|```boolean getIsLike(int userID, int movieID)```|
||前置条件|无|
||后置条件|系统返回该用户是否已经想看这部电影|
|MovieLikeService.getLikeDataOf|语法|```List<Map<String, Object>> getLikeDataOf(int movieID)```|
||前置条件|用户发起请求查看电影的想看人数数据|
||后置条件|系统返回想看人数数据|

|提供的服务（供接口）|||
|-|-|-|
|```MovieLikeMapper.insertSelective(MovieLike record)```|插入一条记录|
|```MovieLikeMapper.deleteByUserAndMovie(MovieLike record)```|删除一条记录|
|```MovieLikeMapper.selectByUserAndMovie(MovieLike record)```|获得一条记录|

- 表11 ArrangementInfo的接口规范

|提供的服务（供接口）|||
|-|-|-|
|ArrangementInfo.movieHasArrangement|语法|```public boolean movieHasArrangement(int movieID)```|
||前置条件|无|
||后置条件|返回根据电影id查询电影有没有排片的结果|

- 表12 PromotionInfo的接口规范

|提供的服务（供接口）|||
|-|-|-|
|PromotionInfo.getJoinedPromotionOf|语法|```public List<String> getJoinedPromotionOf(int movieID)```|
||前置条件|无|
||后置条件|返回根据电影id查询电影参与的优惠活动的结果|

- 表13 StatisticsInfo的接口规范

|提供的服务（供接口）|||
|-|-|-|
|StatisticsInfo.getHeatOf|语法|```public double getHeatOf(int movieID)```|
||前置条件|无|
||后置条件|返回根据电影id查询电影热度的结果|

##### 4.1.2.4 业务逻辑层的动态模型

- 下图表示了用户上架电影时，电影业务逻辑处理的相关对象之间的协作。

![上架电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/releaseMovieSD.jpg?raw=true)

- 下图表示了影院员工用户查看所有已上架电影时，电影业务逻辑处理的相关对象之间的协作。

![查看所有已上架电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/getMovieListSD.jpg?raw=true)

- 下图表示了观众用户查看所有已上架电影时，电影业务逻辑处理的相关对象之间的协作。

![观众查看所有已上架电影的顺序图]()

- 下图表示了观众用户查看电影详情时，电影业务逻辑处理的相关对象之间的协作。

![观众查看电影详情的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/getMovieSD.jpg?raw=true)

- 下图表示了影院员工用户查看电影详情时，电影业务逻辑处理的相关对象之间的协作。

![查看电影详情的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/getMovieSD.jpg?raw=true)

- 下图表示了用户搜索电影时，电影业务逻辑处理的相关对象之间的协作。

![搜索电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/searchSD.jpg?raw=true)

- 下图表示了用户标记想看电影时，电影业务逻辑处理的相关对象之间的协作。

![标记想看电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/likeSD.jpg?raw=true)

- 下图表示了用户取消想看电影时，电影业务逻辑处理的相关对象之间的协作。

![取消想看电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/unlikeSD.jpg?raw=true)

- 下图表示了用户修改电影时，电影业务逻辑处理的相关对象之间的协作。

![修改电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/moviebl_modify_SD.jpg?raw=true)

- 下图表示了用户下架电影时，电影业务逻辑处理的相关对象之间的协作。

![下架电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/moviebl_withdraw_SD.jpg?raw=true)

##### 4.1.2.5 业务逻辑层的设计原理

利用委托式控制风格，每个界面需要的业务逻辑由各自的控制器委托给不同的业务逻辑对象。

#### 4.1.3 cinemabl模块

##### 4.1.3.1 模块概述

cinemabl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。
cinemabl模块的职责及接口参见软件系统结构描述文档。

##### 4.1.3.2 整体结构

根据体系结构的设计，我们将系统分为展示层，业务逻辑层，数据层。每一层之间为了增加灵活性，我们会添加接口。比如展示层和业务逻辑层之间，我们添加blservices.cinema.ArrangementService,blservices.cinema.ArrangementManage,blservices.cinema.HallManage接口。业务逻辑层和数据层之间添加dataservice.cinema.HallMapper,dataservice.cinema.SeatMapper,dataservice.cinema.ArrangementMapper,dataservice.cinema.ArrangementSeatMapper接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了ArrangementController和HallController，这样会将对用户的业务逻辑处理委托给业务逻辑对象。

- cinemabl模块的设计如图所示。

![cinemabl模块各个类的设计](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/cinemabl_detailed_class_diagram.png)

- 表14 cinemabl模块各个类的职责
  
|模块|职责|
|-|-|
| HallController | 负责接受展示层传递的影厅管理相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层 |
| ArrangementController | 负责接受展示层传递的排片查询、管理相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层 |
| ArrangementService | 观众排片查看、查询的业务逻辑服务接口，可以解决排片查看、查询的问题 |
| ArrangementManage | 影院员工排片管理的业务逻辑服务接口，可以解决管理排片的问题 |
| HallManage | 影厅管理的业务逻辑服务接口，可以解决管理影厅的问题 |

##### 4.1.3.3 模块内部类的接口规范

- 表15 ArrangementController的接口规范

|提供的服务（供接口）|||
|-|-|-|
|ArrangementController.addManageArrangement|语法|```public Response addManageArrangement(@RequestBody ArrangementForm arrangementForm)```|
||前置条件|请求添加排片的已登录用户具有添加排片的权限|
||后置条件|返回添加排片的结果到展示层|
|ArrangementController.getArrangement|语法|```public Response getArrangement(@RequestParam int movieId)```|
||前置条件|发起请求的用户已经登录且为观众|
||后置条件|返回根据电影ID查询排片的结果到展示层|
|ArrangementController.getManageArrangementsByHallIDAndDate|语法|```public Response getManageArrangement(@RequestParam int hallId, @RequestParam Date startDate)```|
||前置条件|发起请求的用户已经登录且是管理员|
||后置条件|返回根据影厅ID和开始日期查询排片的结果到展示层|
|ArrangementController.removeManageArrangement|语法|```public Response removeManageArrangement(@RequestParam int arrangementId)```|
||前置条件|请求删除排片的已登录用户具有删除排片的权限|
||后置条件|返回删除排片的结果到展示层|
|ArrangementController.updateManageArrangement|语法|```public Response updateManageArrangement(@RequestBody ArrangementForm arrangementForm,@RequestParam int arrangementId)```|
||前置条件|请求修改排片的已登录用户具有修改排片的权限|
||后置条件|返回修改排片的结果到展示层|
|ArrangementController.getSeatMap|语法|```public Response getSeatMap(@RequestParam int arrangementId)```|
||前置条件|发起请求的用户已经登录且为观众|
||后置条件|返回座位分布表到展示层|

|需要的接口（需接口）||
|-|-|
|```ArrangementService.getByMovieID(int movieID)```|根据电影id获取电影排片信息|
|```ArrangementService.getSeatMap(int aID)```|根据排片id获得排片座位信息|
|```ArrangementManagement.addArrangement(ArrangementForm arrangementForm)```|添加一个排片|
|```ArrangementManagement.modifyArrangement(ArrangementForm arrangementForm, int ID)```|修改一个排片|
|```ArrangementManagement.removeArrangement(int ID)```|移除一个排片|
|```ArrangementManagement.getArrangementsByHallID(int hallID, Date startDate)```|根据影厅ID获取排片|
|```ArrangementManagement.getArrangementsByDay(Date startDate, Date endDate)```|根据日期获得一系列排片|

- 表16 HallController的接口规范

|提供的服务（供接口）|||
|-|-|-|
|HallController.addHall|语法|```public Response addHall(@RequestBody HallForm hallForm)```|
||前置条件|请求添加影厅的已登录用户具有添加影厅的权限|
||后置条件|返回添加影厅的结果到展示层|
|HallController.getAllHall|语法|```public Response getAllHall()```|
||前置条件|发起请求的用户已经登录且有查看所有影厅的权限|
||后置条件|返回查询所有影厅的结果到展示层|
|HallController.updateHall|语法|```public Response updateHall(@RequestBody HallForm hallForm, @RequestParam int hallId)```|
||前置条件|发起请求的用户已经登录且是管理员|
||后置条件|返回修改影厅的结果到展示层|

|需要的接口（需接口）||
|-|-|
|```public Response inputHallInfo(HallForm hallForm)```|添加一个影厅|
|```public Response modifyHallInfo(HallForm hallForm, int ID)```|修改一个影厅信息|
|```public Response getAllHallInfo()```|获得所有影厅|

- 表17 ArrangementService的接口规范

|提供的服务（供接口）|||
|-|-|-|
|ArrangementService.getByMovieID|语法|```Response getByMovieID(int movieID)```|
||前置条件|无|
||后置条件|用电影ID查看此电影的全部排片|
|ArrangementService.getSeatMap|语法|```Response getSeatMap(int aID)```|
||前置条件|无|
||后置条件|系统返回该排片的座位分布图|
|ArrangementService.getFareByID|语法|```float getFareByID(int arrangementID)```|
||前置条件|无|
||后置条件|系统返回通过排片ID获得的此排片票价|
|ArrangementService.changeArrangementSeatStatus|语法|```void changeArrangementSeatStatus(int arrangementID, int seatID, boolean locked)```|
||前置条件|无|
||后置条件|系统改变此排片的座位状态|
|ArrangementService.isArrangementStart|语法|```boolean isArrangementStart(int ID)```|
||前置条件|无|
||后置条件|系统返回此排片是否已经开始放映|
|ArrangementService.getMovieIDbyID|语法|```int getMovieIDbyID(int ID)```|
||前置条件|无|
||后置条件|系统返回此排片对应的电影ID|
|ArrangementService.getStartDateAndEndDate|语法|```Date[] getStartDateAndEndDate(int ID)```|
||前置条件|无|
||后置条件|系统返回排片的开始时间和结束时间|
|ArrangementService.getHallNameByArrangementID|语法|```String getHallNameByArrangementID(int ID)```|
||前置条件|无|
||后置条件|系统返回排片的影厅名称|
|ArrangementService.haveArrangementAfterCurrentTime|语法|```boolean haveArrangementAfterCurrentTime(int hallID, Date currentTime)```|
||前置条件|无|
||后置条件|系统返回当前时间以后该影厅是否还有排片|
|ArrangementService.isSeatBeenLocked|语法|```boolean isSeatBeenLocked(int arrangementID, int seatID)```|
||前置条件|无|
||后置条件|系统返回该座位是否已经被锁|

|需要的接口（需接口）||
|-|-|
|```HallMapper.selectByPrimaryKey(Integer id)```|通过影厅ID获得影厅信息|
|```ArrangementMapper.selectByPrimaryKey(Integer id)```|通过排片ID获得排片信息|
|```ArrangementMapper.selectByMovieID(int movieID)```|通过影片ID获得排片信息|
|```ArrangementMapper.selectByDay(Date startDay,Date endDay)```|通过开始、结束日期获得这两个日期内的所有排片|
|```ArrangementSeatMapper.updateSeatStatus(ArrangementSeat record)```|改变某个排片下某个座位的状态|
|```ArrangementSeatMapper.select(ArrangementSeat record)```|座位是否被锁|
|```ArrangementSeatMapper.selectByArrangementID(int arrangementId)```|通过排片ID获得座位信息|
|```SeatMapper.selectByPrimaryKey(Integer id)```|通过座位ID获得座位记录|

- 表18 HallManagement

|提供的服务（供接口）|||
|-|-|-|
|HallManagement.inputHallInfo|语法|```Response inputHallInfo(HallForm hallForm)```|
||前置条件|无|
||后置条件|系统返回是否添加成功|
|HallManagement.modifyHallInfo|语法|```Response modifyHallInfo(HallForm hallForm, int ID)```|
||前置条件|无|
||后置条件|系统返回是否修改成功|
|HallManagement.getAllHallInfo|语法|```Response getAllHallInfo()```|
||前置条件|无|
||后置条件|系统返回所有的影厅信息|
|HallManagement.getAverageSeatNum|语法|```double getAverageSeatNum()```|
||前置条件|无|
||后置条件|系统返回影院影厅的平均座位数|
|HallManagement.getSeatNumByHallID|语法|```int getSeatNumByHallID(int hallID)```|
||前置条件|无|
||后置条件|系统返回某个影厅的座位数|
|HallManagement.getSeatBySeatID|语法|```int[] getSeatBySeatID(int seatID)```|
||前置条件|座位ID没有超出影厅的座位ID范围|
||后置条件|系统返回行和列|
|HallManagement.getHallNameByID|语法|```String getHallNameByID(int ID)```|
||前置条件|影厅的ID是现有的影厅ID之一|
||后置条件|系统返回影厅名字|

|需要的接口（需接口）||
|-|-|
|服务名|服务|
|```HallMapper.insertSelective(Hall record)```|插入一个影厅，为null的值不会被添加，参数的id设为插入后的id|
|```HallMapper.deleteByPrimaryKey(Integer id)```|给定一个影厅id，删除这个影厅|
|```HallMapper.updateByPrimaryKeySelective(Hall record)```|通过影厅id唯一更新一个影厅记录，为null的值不会被添加，必须有id|
|```HallMapper.selectByPrimaryKey(Integer id)```|通过id查找影厅|
|```HallMapper.selectAll()```|返回所有的影厅|
|```SeatMapper.insertSelective(Seat record)```|插入一个座位记录，为null的属性不会被添加|
|```SeatMapper.deleteByPrimaryKey(Integer id)```|通过座位id删除座位纪录|
|```SeatMapper.updateByPrimaryKeySelective(Seat record)```|通过id唯一更新一条座位纪录，为null的属性不会被添加|
|```SeatMapper.selectByPrimaryKey(Integer id)```|通过座位id获取座位纪录|
|```SeatMapper.selectAll()```|返回所有座位|
|```SeatMapper.selectByHallID(int hallID)```|通过影厅id查找到影厅的所有座位|
|```SeatMapper.deleteByHallID(int hallID)```|根据影厅id删除影厅的所有座位|

- 表19 ArrangementManagement

|提供的服务（供接口）|||
|-|-|-|
|ArrangementManagement.addArrangement|语法|```Response addArrangement(ArrangementForm arrangementForm)```|
||前置条件|无|
||后置条件|添加排片信息|
|ArrangementManagement.modifyArrangement|语法|```Response modifyArrangement(ArrangementForm arrangementForm, int ID)```|
||前置条件|无|
||后置条件|修改排片信息|
|ArrangementManagement.removeArrangement|语法|```Response removeArrangement(int ID)```|
||前置条件|无|
||后置条件|删除排片信息|
|ArrangementManagement.getArrangementsByHallID|语法|```Response getArrangementsByHallID(int hallID, Date startDate)```|
||前置条件|无|
||后置条件|返回根据影厅查看排片信息|
|ArrangementManagement.getArrangementsByDay|语法|```List<Arrangement> getArrangementsByDay(Date startDate, Date endDate)```|
||前置条件|无|
||后置条件|返回这两个日期内的所有排片|

|需要的接口（需接口）||
|-|-|
|服务名|服务|
|```HallMapper.selectByPrimaryKey(Integer id)```|通过ID查找影厅|
|```SeatMapper.selectByHallID(int hallID)```|通过影厅id查找到影厅的所有座位|
|```SeatMapper.selectByPrimaryKey(Integer id)```|通过座位ID获得座位|
|```ArrangementMapper.insertSelective(Arrangement record)```|插入排片记录，为null的属性不会被写进sql语句中|
|```ArrangementMapper.deleteByPrimaryKey(Integer id)```|通过排片ID删除排片|
|```ArrangementMapper.updateByPrimaryKeySelective(Arrangement record)```|更新排片记录，为null的属性不会被写进sql语句中|
|```ArrangementMapper.selectByPrimaryKey(Integer id)```|通过排片ID查找排片记录|
|```ArrangementMapper.selectByMovieID(int movieID)```|通过电影ID查找排片|
|```ArrangementMapper.selectByHallIDAndStartDate(int hallID,Date startDate,int duration)```|通过影厅ID和一个开始日期查找排片，默认返回duration天内的排片|
|```ArrangementMapper.selectByHallIDAndCurrentTime(int hallID,Date currentTime)```|查找当前时间后的在该影厅的所有排片，没有返回null|
|```ArrangementMapper.selectByDay(Date startDay,Date endDay)```|获取开始时间晚于startDay的0时，结束时间早于endDay的0时的所有排片|
|```ArrangementSeatMapper.insertSelective(ArrangementSeat record)```|插入一条记录，为null的属性不会被写进sql语句中|
|```ArrangementSeatMapper.delete(ArrangementSeat record)```|删除一条记录|
|```ArrangementSeatMapper.updateSeatStatus(ArrangementSeat record)```|更新一条记录，排片id和座位id都必须有|
|```ArrangementSeatMapper.select(ArrangementSeat record)```|查找一条记录|
|```ArrangementSeatMapper.selectByArrangementID(int arrangementId)```|通过排片ID获取记录|

##### 4.1.3.4 业务逻辑层的动态模型

- 下图表示了添加排片时，影院业务逻辑处理的相关对象之间的协作。

![添加排片的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_addArrangement.png?raw=true)

- 下图表示了修改排片的电影时，影院业务逻辑处理的相关对象之间的协作。

![修改排片的电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_changeMovie.png?raw=true)

- 下图表示了修改一个排片的起止时间时，影院业务逻辑处理的相关对象之间的协作。

![修改一个排片的起止时间的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_changeTime.png?raw=true)

- 下图表示了通过日期和影厅ID获取排片时，影院业务逻辑处理的相关对象之间的协作。

![通过日期和影厅ID获取排片的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_getByHallID.png?raw=true)

- 下图表示了通过日期和电影ID获取排片时，影院业务逻辑处理的相关对象之间的协作。

![通过日期和电影ID获取排片的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_getByMovieID.png?raw=true)

- 下图表示了删除一个排片时，影院业务逻辑处理的相关对象之间的协作。

![删除一个排片的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_removeArrangement.png?raw=true)

- 下图表示了设定一定时间内的排片的观众可见日期时，影院业务逻辑处理的相关对象之间的协作。

![设定一定时间内的排片的观众可见日期的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinemabl_sd_setVisibleTime.png?raw=true)

- 下图表示了获取某部排片的座位信息时，影院业务逻辑处理的相关对象之间的协作。

![获取某部排片的座位信息的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/cinamebl_sd_getSeatMap.png?raw=true)

##### 4.1.3.5 业务逻辑层的设计原理

利用委托式控制风格，每个界面需要的业务逻辑由各自的控制器委托给不同的业务逻辑对象。

#### 4.1.4 VIPcardbl模块

##### 4.1.4.1 模块概述

VIPcardbl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。
VIPcardbl模块的职责及接口参见软件系统结构描述文档。

##### 4.1.4.2 整体结构

根据体系结构的设计，我们将系统分为展示层，业务逻辑层，数据层。每一层之间为了增加灵活性，我们会添加接口。比如展示层和业务逻辑层之间，我们添加blservices.vip.VIPCardService和blservices.vip.VIPManagement接口。业务逻辑层和数据层之间添加dataservice.vip.VIPcardMapper,dataservice.vip.TradeRecord,Mapperdataservice.vip.VIPcardRechargeReductionMapper接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了VipController，这样Controller会将对用户的业务逻辑处理委托给业务逻辑对象。SalesInfo和VIPCouponBusiness是根据依赖倒置原则，为了消除循环依赖而产生的接口。

- vipcardbl模块的设计如图所示。

![vipcardbl模块各个类的设计](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/vipcardbl_detailed_class_diagram.png)

- 表20 vipcardbl模块各个类的职责

| 模块| 职责|
| - | - |
| VipController | 负责接受展示层传递的会员卡信息获取、会员卡支付和管理相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层 |
| VIPCardService | 会员卡的业务逻辑服务接口，可以解决会员卡信息查看、购买会员卡、支付和给予其他业务逻辑需要的会员卡信息的问题 |
| VIPManagement | 会员卡管理的业务逻辑服务接口，可以解决会员充值优惠管理和赠送优惠券的问题 |

##### 4.1.4.3 模块内部类的接口规范

- 表21 VipController的接口规范

| 提供的服务（供接口）|||
| - | - | - |
|VipController.getVIPInfo | 语法 |```public Response getVIPCard(@RequestParam int userId)```|
|| 前置条件 | 发起请求的已登录用户具有查看会员卡信息的权限，且是会员卡拥有者本人|
|| 后置条件 | 返回查询会员卡信息的结果到展示层 |
|VipController.depositable | 语法 |```public Response depositable(@RequestParam float amount)```|
|| 前置条件 | 发起请求的已登录的用户具有充值会员卡的权限，且是会员卡拥有者本人 |
|| 后置条件 | 转入业务逻辑充值流程，返回可重置性及充值应付金额到展示层 |
|VipController.payDeposit|语法|```public Response payDeposit(@PathVariable String orderID)```|
||前置条件| 已经通过depositVIPCard方法获得了订单ID |
||后置条件| 系统返回成功或失败的结果 |
|VipController.buyable|语法|```public Response buyable()```|
||前置条件| 发起请求的已登录用户未持有会员卡，且是参数中userID持有人 |
||后置条件| 进入业务逻辑购买流程，返回能否购买会员卡及购卡金额到展示层|
|VipController.addVIPCard|语法|```public Response addVIPCard(@PathVariable String orderID)```|
||前置条件| 用户已经登陆，且没有会员卡 |
||后置条件| 系统返回成功或失败的结果 |
|VipController.getRechargeReduction|语法|```public Response getRechargeReduction()```|
||前置条件| 无 |
||后置条件| 获得充值优惠策略，满减这些的 |
|VipController.getRechargeHistory|语法|```public Response getRechargeHistory(@RequestParam int userId)```|
||前置条件| 用户已登陆且是VIP用户 |
||后置条件| 系统返回用户的充值记录 |
|VipController.getVIPs|语法|```public Response getVIPs()```|
||前置条件| 发起请求的用户是管理员 |
||后置条件| 系统返回VIP用户的信息 |
|VipController.presentCoupon|语法|```public Response presentCoupon(@RequestBody PresentCouponForm presentCouponForm)```|
||前置条件| 发起请求的用户是管理员 |
||后置条件| 系统返回成功或失败 |
|VipController.addReduction|语法|```public Response addReduction(@RequestBody RechargeReductionVO reductionVO)```|
||前置条件| 发起请求的用户是管理员，优惠信息输入正确 |
||后置条件| 系统返回添加优惠信息成功或失败 |
|VipController.modifyReduction|语法|```public Response modifyReduction(@RequestBody RechargeReductionVO reductionVO)```|
||前置条件| 发起请求的用户是管理员，优惠信息输入正确 |
||后置条件| 系统返回修改优惠信息成功或失败 |
|VipController.removeReduction|语法|```public Response removeReduction(@RequestParam int targetAmount)```|
||前置条件| 发起请求的用户是管理员，优惠信息输入正确 |
||后置条件| 系统返回删除优惠信息成功或失败 |
|VipController.getReduction|语法|```public Response getReduction()```|
||前置条件| 发起请求的用户是管理员 |
||后置条件| 系统返回全部会员卡优惠信息 |

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
|```VIPManagement.getVIPs()```|获取全部vip用户信息|
|```VIPManagement.presentCoupon(List<Integer> vips, List<Integer> couponIDs)```|要被赠送某些优惠券的vip用户列表|
|```VIPManagement.addReduction(RechargeReductionVO reductionVO)```|增加充值优惠信息|
|```VIPManagement.modifyReduction(RechargeReductionVO reductionVO)```|修改充值优惠信息|
|```VIPManagement.removeReduction(int id)```|删除充值优惠信息|
|```VIPCardService.addVIPCard(int userID)```|添加会员卡，前提是第三方支付已经成功了|
|```VIPCardService.buyable(int userID)```|根据用户ID获取是否可付款|
|```VIPCardService.getRechargeReduction()```|获得充值优惠策略|
|```VIPCardService.getRechargeHistory(int userID)```|获得充值记录|
|```VIPCardService.addVIPBalance(int userID, float amount)```|给会员卡退款|
|```VIPCardService.depositable(int userID, float amount)```|检查是否能进行本次充值|
|```VIPCardService.deposit(int userID, String orderID)```|根据用户id和订单id给会员卡充值|
|```VIPCardService.pay(int userID, float amount)```|使用会员卡支付|

- 表22 VIPCardService的接口规范

| 提供的服务（供接口）  |||
| - | - | - |
|VIPCardService.getVIPCard|语法|```public Response getVIPCard(int userID)```|
||前置条件|用户请求获得自己的会员卡对象|
||后置条件|系统返回相应的会员卡对象|
|VIPCardService.addVIPCard|语法|```public Response  addVIPCard(int userID)```|
||前置条件|用户请求购买会员卡|
||后置条件|系统返回购买结果|
|VIPCardService.getRechargeReduction|语法|```public Response getRechargeReduction()```|
||前置条件|用户请求查看所有的充值优惠|
||后置条件|系统返回充值优惠|
|VIPCardService.getRechargeHistory|语法|```public Response getRechargeHistory(int userID)```|
||前置条件|用户请求查看充值记录|
||后置条件|系统返回自己的充值记录|
|VIPCardService.buyable|语法|```public Response buyable(int userID)```|
||前置条件|无|
||后置条件|系统返回是否可以付款|
|VIPCardService.addVIPBalance|语法|```public Response addVIPBalance(int userID, float amount)```|
||前置条件|用户请求退自己用会员卡购买的票|
||后置条件|系统返回结果|
|VIPCardService.depositable|语法|```public Response depositable(int userID, float amount)```|
||前置条件|用户请求充值|
||后置条件|系统返回用户能否充值|
|VIPCardService.deposit|语法|```public Response deposit(int userID, String orderID)```|
||前置条件|用户能充值并且请求充值|
||后置条件|系统返回结果|
|VIPCardService.pay|语法|```public Response pay(int userID, float amount)```|
||前置条件|用户请求用会员卡购票|
||后置条件|系统返回结果|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
|```VipcardMapper.insertSelective(Vipcard record)``` |新增一张会员卡，余额不需要填，默认初始值为0|
|```VipcardMapper.updateByPrimaryKeySelective(Vipcard record)``` |通过id唯一更新一条会员卡记录|
| ```VipcardMapper.selectByPrimaryKey(Integer userId)``` |通过id唯一选择一条会员卡记录|
| ```TradeRecordMapper.insertSelective(TradeRecord record)``` |新增一条交易记录|
| ```TradeRecordMapper.selectByPrimaryKey(Integer id)``` |通过id唯一选择一条交易记录|
| ```TradeRecordMapper.selectByUserID(Integer userID)``` |通过用户ID选择交易记录|
| ```VipcardRechargeReductionMapper.selectByAmount( Float amount)``` |通过金额来寻找最适合的充值策略|

- 表23 VIPManagement的接口规范

| 提供的服务（供接口）  |||
| - | - | - |
|VIPManagement.getAllVIPs|语法|```public Response getVIPs()```|
||前置条件|用户请求获取所有的VIP用户|
||后置条件|系统返回所有的VIP用户|
|VIPManagement.getVIPs|语法|```public Response getVIPs(double money)```|
||前置条件|用户请求获取消费满一定金额的VIP用户|
||后置条件|系统返回相应的VIP用户|
|VIPManagement.presentCoupon|语法|```public Response presentCoupon(List<Integer> vips, List<Integer> couponIDs)```|
||前置条件|管理员需要给VIP用户送优惠券|
||后置条件|系统返回赠送结果|
|VIPManagement.addReduction|语法|```public Response addReduction(RechargeReductionVO reductionVO)```|
||前置条件|用户增加充值优惠策略|
||后置条件|系统返回结果|
|VIPManagement.modifyReduction|语法|```public Response modifyReduction(RechargeReductionVO reductionVO)```|
||前置条件|用户修改充值优惠策略|
||后置条件|系统返回结果|
|VIPManagement.removeReduction|语法|```public Response removeReduction(int id)```|
||前置条件|用户删除充值优惠策略|
||后置条件|系统返回结果|

| 需要的接口（需接口）||
| - | - |
| 服务名| 服务|
| ```VipcardMapper.selectAll()``` |获取所有会员卡对象|
| ```VipcardRechargeReductionMapper.insertSelective(VipcardRechargeReduction record)``` |插入一个充值优惠对象|
| ```VipcardRechargeReductionMapper.deleteByPrimaryKey(Integer targetAmount)``` |删除一个充值优惠对象|
|```VipcardRechargeReductionMapper.updateByPrimaryKeySelective(VipcardRechargeReduction record)``` |更新一个充值优惠对象|
| ```VipcardRechargeReductionMapper.selectByPrimaryKey(Integer targetAmount)``` |获得一个或全部充值优惠对象|

- 表24 SalesInfo的接口规范

| 提供的服务（供接口）  |||
| - | - | - |
|SalesInfo.getConsumption|语法|```float getConsumption(int userID)```|
||前置条件|存在此用户|
||后置条件|获得此用户的历史消费额|

- 表25 VIPCouponBusiness的接口规范

| 提供的服务（供接口）  |||
| - | - | - |
|VIPCouponBusiness.presentCouponTo|语法|```void presentCouponTo(int userID, List<Integer> promotionIDs) throws ServiceException```|
||前置条件|存在此会员用户和存在这些优惠活动|
||后置条件|将优惠券赠送到用户账户|

##### 4.1.4.4 业务逻辑层的动态模型

- 下图表示了给会员卡充值时，会员卡业务逻辑处理的相关对象之间的协作。

![给会员卡充值的顺序图](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/VIPcardbl_sd_topup.png)

- 下图表示了使用会员卡支付时，会员卡业务逻辑处理的相关对象之间的协作。
  

![使用会员卡支付的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/VIPcardbl_sd_pay.png?raw=true)

- 下图表示了获取会员卡信息时，会员卡业务逻辑处理的相关对象之间的协作。

![获取会员卡信息的顺序图](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/VIPcardbl_sd_getVIPcardInfo.png)

- 下图表示了购买会员卡时，会员卡业务逻辑处理的相关对象之间的协作。

![购买会员卡的顺序图](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/VIPcardbl_sd_buyVIPcard.png)

- 下图所示的状态图描述的VIPcard对象的生存期间的状态序列，引起转移的事件，以及因状态转移而伴随的动作

![VIPcard对象的状态图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/VIPcardbl_state.png?raw=true)

##### 4.1.4.5 业务逻辑层的设计原理

利用委托式控制风格，每个界面需要的业务逻辑由各自的控制器委托给不同的业务逻辑对象。

#### 4.1.5 salebl模块

##### 4.1.5.1 模块概述

salebl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。
salebl模块的职责及接口参见软件系统结构描述文档。

##### 4.1.5.2 整体结构

根据体系结构的设计，我们将系统分为展示层，业务逻辑层，数据层。每一层之间为了增加灵活性，我们会添加接口。比如展示层和业务逻辑层之间，我们添加blservices.sale.promotion.CouponService,blservices.sale.promotion.PromotionService,blservices.sale.ticket.RefundTicketManage,blservices.sale.ticket.TicketService,blservices.sale.ticket.TicketStatistics接口。业务逻辑层和数据层之间添加dataservice.sale.promotion.CouponMapper,dataservice.sale.promotion.PromotionMapper,dataservice.sale.promotion.PromotionHasMovieMapper,dataservice.sale.ticket.RefundStrategyMapper,dataservice.sale.ticket.TicketsMapper,dataservice.sale.OrderMapper接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了TicketController,PromotionController,AlipayController，这样Controller会将对用户的业务逻辑处理委托给业务逻辑对象。

- salebl模块的设计如图所示。

![salebl模块各个类的设计](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/salebl_detailed_class_diagram.png)

- 表26 Salebl模块各个类的职责

| 模块| 职责|
| - | - |
| PromotionController |负责接受展示层传递的优惠活动信息获取和管理、优惠券信息获取和使用相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层|
| TicketController |负责接受展示层传递的电影票和订单信息获取、票务相关请求和数据，委托给相应的业务逻辑接口方法处理并返回结果给展示层|
| CouponService | 优惠券的业务逻辑服务接口，可以解决优惠券卡信息查看、使用和发放给予其他业务逻辑需要的会员卡信息的问题 |
| PromotionService | 优惠活动的业务逻辑服务接口，可以解决优惠券信息查看、优惠活动管理和给予其他业务逻辑需要的会员卡信息的问题 |
| RefundTicketManage | 退票策略的业务逻辑服务接口，可以解决退票策略管理和信息获取和给予其他业务逻辑需要的会员卡信息的问题 |
| TicketService | 电影票的业务逻辑服务接口，可以解决电影票信息查看、票务和给予其他业务逻辑需要的会员卡信息的问题 |
| TicketStatistics | 会员卡的业务逻辑服务接口，可以解决会员卡信息查看、购买会员卡、支付和给予其他业务逻辑需要的会员卡信息的问题 |
| PromotionImpl | CouponService,PromotionService，blservices.vip.VIPCouponBusiness, blservices.movie.PromotionInfo接口的一般实现类 |
| TicketImpl | TicketService, blservices.vip.SalesInfo接口的一般实现类 |
| RefundTicketManageImpl | RefundTicketManage接口的一般实现类 |
| TicketStatisticsImpl | TicketStatistics接口的一般实现类 |

##### 4.1.5.3 模块内部类的接口规范

- 表27 PromotionController的接口规范

| 提供的服务（供接口） || |
| - | - | - |
|PromotionController.getAvailableCoupon|语法|```public Response getAvailableCoupon(@RequestParam int userId)```|
||前置条件|用户想看自己拥有的所有可用优惠券|
||后置条件|返回结果到展示层|
|PromotionController.publishPromotion|语法|```public Response publishPromotion(@RequestBody PromotionForm promotionForm)```|
||前置条件|用户已登录身份为影院经理|
||后置条件|将活动添加结果展示给用户|
|PromotionController.getAllPromotions|语法|```public Response getAllPromotions()```|
||前置条件|用户已登录身份为影院经理|
||后置条件|返回结果到展示层|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务|
| ```Sale.publishPromotion(PromotionForm promotionForm)```  |增加一个优惠活动|
| ```Sale.getAllPromotions()```  |返回所有的优惠活动|
|```Sale.getAvailableCouponsByUser(int userId)```|根据用户id返回用户所拥有的全部可用优惠券|

- 表28 TicketController的接口规范

| 提供的服务（供接口） || |
| - | - | - |
|TicketController.lockSeats|语法|```public Response lockSeats(@RequestBody List<Integer> seatId, @PathVariable int arrangementId)```|
||前置条件|排片未开始且可见，座位均为可用状态|
||后置条件|为用户增加该排片该座位的订单|
|TicketController.payOrderByVIP|语法|```public Response payOrderByVIP(@PathVariable long orderID, @RequestBody int couponID)```|
||前置条件|用户拥有vip卡且余额大于应付金额|
||后置条件|将订单状态修改|
|TicketController.getPurchaseRecord|语法|```public Response getPurchaseRecord()```|
||前置条件|用户身份已登录为观众|
||后置条件|无|
|TicketController.cancelOrder|语法|```public Response cancelOrder(@RequestBody long orderId)```|
||前置条件|订单状态为未完成且属于该用户|
||后置条件|将订单的座位释放|
|TicketController.refundTicket|语法|```public Response refundTicket(@RequestBody int ticketId)```|
||前置条件|符合退票策略并该排片未开场|
||后置条件|返回结果展示给用户|
|TicketController.getExistingTickets|语法|```public Response getExistingTickets(@RequestParam int scheduleId)```|
||前置条件|无|
||后置条件|提示用户是否完成该订单|
|TicketController.getUserRefundStrategy|语法|```public Response getUserRefundStrategy()```|
||前置条件|无|
||后置条件| 根据策略显示电影票是否可退                                   |
|TicketController.getRefundStrategy|语法|```public Response getRefundStrategy()```|
||前置条件|用户已登录身份为管理员|
||后置条件|返回结果展示给用户|
|TicketController.addRefundStrategy|语法|```public Response addRefundStrategy(@RequestBody RefundStrategyForm refundStrategyForm)```|
||前置条件|用户已登录身份为管理员|
||后置条件|返回结果展示给用户|
|TicketController.modifyRefundStrategy|语法|```public Response modifyRefundStrategy(@RequestBody RefundStrategyForm refundStrategyForm)```|
||前置条件|用户已登录身份为管理员|
||后置条件|返回结果展示给用户|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务|
|```Sale.lockSeat(List<Integer> seatID, int userID, int arrangementID)```|将座位锁定并生成订单|
|```Sale.payable(long orderID, int couponID, int userID)```|检测订单是否可支付|
|```Sale.payOrder(long orderID, float amount)```|支付订单|
|```Sale.payOrderByVIPCard(long orderID, int userID)```|用vip卡支付订单|
|```Sale.cancelOrder(int userID, long orderID)```|取消未完成订单|
|```Sale.refundTicket(int userID, int ticketID)```|退票|
|```Sale.getOrderByScheduleIdAndUserId(int userId, int scheduleId)```|获取用户某排片未完成订单|
|```Sale.getHistoricalConsumptionsByUserId(int userId)```|获取历史消费记录|
|```Sale.addRefundTicketManage(RefundStrategyForm refundStrategyForm)```|增加退票策略|
|```Sale.modifyRefundTicketManage(RefundStrategyForm refundStrategyForm)```|更新退票策略|
|```Sale.getAllRefunds()```|获取所有退票策略|

- 表29 CouponService的接口规范

| 提供的服务（供接口）|| |
| - | - | - |
|CouponService.getAvailableCouponsByUser|语法|```public Response getAvailableCouponsByUser(int userId)```|
||前置条件|用户请求查看自己可用的优惠券|
||后置条件|系统返回用户的所有可用的优惠券|
|CouponService.getAvailableCouponsByUserAndTickets|语法|```List<CouponVO> getAvailableCouponsByUserAndTickets(int userId, float totalAmount)```|
||前置条件|无|
||后置条件|返回所有可用优惠券|
|CouponService.removeCouponByID|语法|```void removeCouponByID(int ID)```|
||前置条件|优惠券属于该用户|
||后置条件|提示用户优惠券已使用|
|CouponService.sendCouponsToUser|语法|```void sendCouponsToUser(int userID, int movieID)```|
||前置条件|该电影存在优惠活动|
||后置条件|无|
|CouponService.getCouponAmountByID|语法|```float getCouponAmountByID(int ID)```|
||前置条件|无|
||后置条件|无|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务 |
|```PromotionMapper.selectByPrimaryKey(Integer id)```|通过id获取优惠活动|
|```PromotionMapper.selectAll()```|获取所有优惠活动|
|```CouponMapper.insertSelective(Coupon record)```|赠送用户优惠券|
|```CouponMapper.deleteByPrimaryKey(Integer id)```|删除某优惠券|
|```CouponMapper.updateByPrimaryKeySelective(Coupon record)```|更新优惠券|
|```CouponMapper.selectByPrimaryKey(Integer id)```|根据id获取优惠券|
|```CouponMapper.selectByUserID(int userID)```|根据用户id获取优惠券|

- 表30 PromotionService的接口规范

| 提供的服务（供接口）|| |
| - | - | - |
| PromotionService.publishPromotion| 语法| ```public Response publishPromotion(PromotionForm promotionForm)```  |
|| 前置条件 | 管理员请求发布优惠活动|
|| 后置条件 | 系统返回优惠活动发布结果给展示层并更新优惠策略|
| PromotionService.getAllPromotions| 语法| ```public Response getAllPromotions()```  |
|| 前置条件 | 管理员请求查看所有优惠活动|
|| 后置条件 | 系统返回所有优惠活动|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务 |
|```PromotionHasMovieMapper.insertSelective(PromotionHasMovie record)```|增加参与优惠活动的电影记录|
|```PromotionHasMovieMapper.deleteByPrimaryKey(PromotionHasMovie key)```|删除参与优惠活动的电影记录|
|```PromotionHasMovieMapper.selectByPromotionID(int promotionID)```|根据优惠活动id查找参与优惠活动的电影|
|```PromotionHasMovieMapper.selectByMovieID(Integer movieID)```|通过电影id查找参与的优惠活动|
|```PromotionMapper.insertSelective(Promotion record)```|添加一个优惠活动|
|```PromotionMapper.deleteByPrimaryKey(Integer id)```|通过id删除优惠活动|
|```PromotionMapper.updateByPrimaryKeySelective(Promotion record)```|更新一个优惠活动|
|```PromotionMapper.selectByPrimaryKey(Integer id)```|根据id查找优惠活动|
|```PromotionMapper.selectAll()```|返回所有优惠活动|

- 表31 RefundTicketManage的接口规范

| 提供的服务（供接口）|| |
| - | - | - |
|RefundTicketManage.addRefundTicketManage|语法|```public Response addRefundTicketManage(RefundStrategyForm refundStrategyForm)```|
||前置条件|用户请求新增退票策略|
||后置条件|系统返回新增结果|
|RefundTicketManage.modifyRefundTicketManage|语法|```public Response modifyRefundTicketManage(RefundStrategyForm refundStrategyForm)```|
||前置条件|用户请求修改退票策略|
||后置条件|系统返回修改结果|
|RefundTicketManage.getAllRefunds|语法|```public  Response getAllRefunds()```|
||前置条件|用户请求获得所有退票策略|
||后置条件|系统返回所有退票策略|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务 |
|```RefundStrategyMapper.insertSelective(RefundStrategy record)```|插入一个退票策略对象|
|```RefundStrategyMapper.deleteByPrimaryKey(Integer id)```|删除一个退票策略对象|
|```RefundStrategyMapper.updateByPrimaryKeySelective(RefundStrategy record)```|修改一个退票策略对象|
|```RefundStrategyMapper.selectByPrimaryKey(Integer id)```|获得一个退票策略对象|
|```RefundStrategyMapper.selectAll()```|获得所有的退票策略对象|

- 表32 TicketService的接口规范

| 提供的服务（供接口）|| |
| - | - | - |
|TicketService.lockSeat|语法|```public Response lockSeat(List<Integer> seatID, int userID, int arrangementID)```|
||前置条件|用户锁座前购票|
||后置条件|系统返回用户锁座后生成的订单|
|TicketService.payable|语法|```public Response payable(long orderID, int couponID, int userID)```|
||前置条件|用户请求支付订单|
||后置条件|返回用户是否能否支付|
|TicketService.payOrder|语法|```public Response payOrder(long orderID, float amount)```|
||前置条件|用户能够支付订单|
||后置条件|返回支付结果|
|TicketService.payOrderByVIPCard|语法|```public Response payOrderByVIPCard(long orderID, int userID)```|
||前置条件|用户请求用会员卡支付订单并能够用会员卡支付订单|
||后置条件|返回支付结果|
|TicketService.cancelOrder|语法|```public Response cancelOrder(int userID, long orderID)```|
||前置条件|用户请求取消订单|
||后置条件|返回取消结果|
|TicketService.refundTicket|语法|```public Response refundTicket(int userID, int ticketID)```|
||前置条件|用户请求退票|
||后置条件|返回退票结果|
|TicketService.getOrderByScheduleIdAndUserId|语法|```public Response getOrderByScheduleIdAndUserId(int userId, int scheduleId)```|
||前置条件|用户进入一场排片|
||后置条件|系统返回用户此前在该场排片是否有未完成订单|
|TicketService.getHistoricalConsumptionsByUserId|语法|```public Response getHistoricalConsumptionsByUserId(int userId)```|
||前置条件|用户选择查看自己的历史消费记录|
||后置条件|系统返回用户的历史消费记录|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务 |
|```OrderMapper.insertSelective(Order record)```|插入一个订单对象|
|```OrderMapper.deleteByPrimaryKey(Long id)```|删除一个订单对象|
|```OrderMapper.updateByPrimaryKeySelective(Order record)```|修改一个订单对象|
|```OrderMapper.selectByPrimaryKey(Long id)```|获得一个订单对象|
|```OrderMapper.selectByUserAndOrderID(int userID, long orderID)```|确认该订单是否是该用户的|
|```TicketsMapper.insertSelective(Ticket record)```|插入一个电影票对象|
|```TicketsMapper.deleteByPrimaryKey(Integer id)```|删除一个电影票对象|
|```TicketsMapper.updateByPrimaryKeySelective(Ticket record)```|修改一个电影票对象|
|```TicketsMapper.selectByPrimaryKey(Integer id)```|获得一个电影票对象|
|```TicketsMapper.selectByUserID(int userID)```|获得用户的所有电影票|
|```TicketsMapper.selectByOrderID(long orderID)```|获得该订单包含的所有电影票|
|```TicketsMapper.selectByMovieID(int movieID)```|获得该电影的所有电影票|
|```TicketsMapper.selectByArrangementID(int arrangementID)```|获得该场排片的所有电影票|
|```TicketsMapper.selectByDate(Date startDate, Date endDate)```|获得时间段内的所有电影票|
|```RefundStrategyMapper.selectByDay(long dayToCome)```|获得最适合该天数的退票策略|

- 表33 TicketStatistics的接口规范

| 提供的服务（供接口）|| |
| - | - | - |
|TicketStatistics.getAudiencePriceByDay|语法|```float getAudiencePriceByDay(Date startDate, Date endDate)```|
||前置条件|无|
||后置条件|返回时间段内的客单价|
|TicketStatistics.getNumOfTicketsByArrangement|语法|```int getNumOfTicketsByArrangement(int arrangementID)```|
||前置条件|无|
||后置条件|返回排片的已出售票数|
|TicketStatistics.getBoxOfficeByMovieIDAndDay|语法|```float getBoxOfficeByMovieIDAndDay(int movieID, Date startDate, Date endDate)```|
||前置条件|无|
||后置条件|返回时间段内电影的票房|
|TicketStatistics.getTotalBoxOfficeByMovieID|语法|```float getTotalBoxOfficeByMovieID(int movieID)```|
||前置条件|无|
||后置条件|返回电影总票房|

| 需要的服务（需接口） | |
| - | - |
| 服务名 | 服务 |
|```TicketsMapper.selectByMovieID(int movieID)```|返回该电影的所有电影票|
|```TicketsMapper.selectByArrangementID(int arrangementID)```|返回该排片的所有电影票|

##### 4.1.5.4 业务逻辑层的动态模型

- 下图表示了获取近期最受欢迎电影时，销售业务逻辑处理的相关对象之间的协作。（统计上座率，客单价，票房，排片的各对象协作与此类似）

![获取近期最受欢迎电影的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/salebl_sd_getFavoriteMovie.jpg?raw=true)

- 下图表示了获取订单信息时，销售业务逻辑处理的相关对象之间的协作。

![获取订单信息的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/salebl_sd_getOrderInfo.jpg?raw=true)

- 下图表示了支付时，销售业务逻辑处理的相关对象之间的协作。

![支付的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/salebl_sd_pay.jpg?raw=true)

- 下图表示了发布一条优惠策略时，销售业务逻辑处理的相关对象之间的协作。

![发布一条优惠策略的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/salebl_sd_releasePromotion.jpg?raw=true)

- 下图表示了锁定座位时，销售业务逻辑处理的相关对象之间的协作。

![锁定座位的顺序图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/salebl_sd_setChosenSeat.jpg?raw=true)

- 下图所示的状态图描述的Sale对象的生存期间的状态序列，引起转移的事件，以及因状态转移而伴随的动作

![Sale对象的状态图](https://github.com/Translucentwall/UMLImage/blob/master/docTask4/salebl_statechartDiagram.jpg?raw=true)

##### 4.1.5.5 业务逻辑层的设计原理

利用委托式控制风格，每个界面需要的业务逻辑由各自的控制器委托给不同的业务逻辑对象。

#### 4.1.6 statisticsbl模块

##### 4.1.6.1 模块概述

statisticsbl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。
statisticsbl模块的职责及接口参见软件系统结构描述文档。

##### 4.1.6.2 整体结构

根据体系结构的设计，我们将系统分为展示层，业务逻辑层，数据层。每一层之间为了增加灵活性，我们会添加接口。比如展示层和业务逻辑层之间，我们添加blservices.statistics.Statistics接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了StatisticsController，这样StatisticsController会将对用户的业务逻辑处理委托给Statistics对象。

- statisticsbl模块的设计如图所示。
  

![statisticsbl的模块设计图](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/statisticsbl_detailed_class_diagram.png)

- 表34 statisticsbl模块各个类的职责
| 模块| 职责|
| - | - |
| StatisticsController |负责实现统计界面所需要的服务|
| statistics|统计的业务逻辑服务接口，可以实现统计所需要的服务|

#### 4.1.6.3 模块内部类的接口规范

- 表35 StatisticsController的接口规范

| 提供的服务（供接口） || |
| - | - | - |
|StatisticsController.getScheduleRateByDate|语法|```public Response getScheduleRateByDate(Date date)```|
||前置条件|无|
||后置条件|返回排片率到展示层|
|StatisticsController.getTotalBoxOffice|语法|```public Response getTotalBoxOffice()```|
||前置条件|无|
||后置条件|返回总票房到展示层|
|StatisticsController.getAudiencePrice|语法|```public Response getAudiencePrice(int days)```|
||前置条件|无|
||后置条件|返回客单价到展示层|
|StatisticsController.getMoviePlacingRateByDate|语法|```public Response getMoviePlacingRateByDate(Date date)```|
||前置条件|无|
||后置条件|返回电影上座率到展示层|
|StatisticsController.getPopularMovies|语法|```public Response getPopularMovies(int days,int movieNum)```|
||前置条件|无|
||后置条件返回最受欢迎电影列表到展示层||

|需要的接口（需接口）||
|-|-|
|服务名|服务|
|Statistics.getScheduleRateByDate|获得排片率|
|Statistics.getTotalBoxOffice|获得总票房|
|Statistics.getAudiencePrice|获得客单价|
|Statistics.getMoviePlacingRateByDate|获得电影上座率|
|Statistics.getPopularMovies|获得受欢迎电影|

- 表36 Statistics的接口规范

|提供的服务（供接口)|||
|-|-|-|
|Statistics.getScheduleRateByDate|语法|```public Response getScheduleRateByDate(Date date)```|
||前置条件|用户请求获得排片率|
||后置条件|系统返回排片率|
|Statistics.getTotalBoxOffice|语法|```public Response getTotalBoxOffice()```|
||前置条件|用户请求获得总票房|
||后置条件|系统返回总票房|
|Statistics.getAudiencePrice|语法|```public Response getAudiencePrice(int days)```|
||前置条件|用户请求获得客单价|
||后置条件|系统返回客单价|
|Statistics.getMoviePlacingRateByDate|语法|```public Response getMoviePlacingRateByDate(Date date)```|
||前置条件|用户请求获得电影排片率|
||后置条件|系统返回电影排片率|
|Statistics.getPopularMovies|语法|```public Response getPopularMovies(int days, int movieNum)```|
||前置条件|用户请求获得最受欢迎电影列表|
||后置条件|系统返回最受欢迎列表|

|需要的服务（需接口）||
|-|-|
|服务名|服务|
|ticketStatistics.getAudiencePriceByDay|通过日期获得客单价|
|ticketStatistics.getNumOfTicketsByArrangement|获得该场排片的已出售的票数|
|ticketStatistics.getBoxOfficeByMovieIDAndDay|通过电影ID和日期获得票房|
|arrangementManage.getArrangementsByDay|获得时间段内的排片|
|movieManagement.getReleasedMovies|获得已上映的电影|
|movieManagement.getMovieByID|通过电影ID获得电影对象|
|hallManage.getSeatNumByHallID|通过影厅ID获得影厅的座位数|

### 4.2 数据层的分解

#### 4.2.1 userdataservice 模块

##### 4.2.1.1 模块概述

userdataservice模块的职责参见体系结构文档。

##### 4.2.1.2 模块内部类的接口规范

UserMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| -------- | -------- | -------------- |
| UserMapper.insertSelective| 语法| ```public int insertSelective(User record)```|
|| 前置条件 | 相同username或相同id的PO在数据库中不存在|
|| 后置条件 | 在数据库中增加一个PO记录|
| UserMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Integer id)```|
|| 前置条件 | 相同id的PO在数据库中存在|
|| 后置条件 | 在数据库中删除一个PO记录|
| UserMapper.updateByPrimaryKeySelective| 语法| ```public int updateByPrimaryKeySelective(User record)```|
|| 前置条件 | 相同username或相同id的PO在数据库中存在|
|| 后置条件 | 在数据库中更新一个PO记录|
| UserMapper.selectByPrimaryKey| 语法| ```public User selectByPrimaryKey(Integer id)```|
|| 前置条件 | 相同id的PO在数据库中存在|
|| 后置条件 | 返回一个PO记录|
| UserMapper.selectByName| 语法| ```public User selectByName(String name)```|
|| 前置条件 | 相同username的PO在数据库中存在|
|| 后置条件 | 返回一个PO记录|
| UserMapper. selectAllStaff| 语法| ```public List<Staff> selectAllStaff()```|
|| 前置条件 | 无|
|| 后置条件 | 返回所有的员工PO|
| UserMapper.selectAllManager| 语法| ```public List<Manager> selectAllManager()```|
|| 前置条件 | 无|
|| 后置条件 | 返回所有的经理PO|
| UserMapper.selectStaffByName| 语法| ```public Staff selectStaffByName(String name)```|
|| 前置条件 | 相同username的员工PO在数据库中存在|
|| 后置条件 | 返回一个员工PO|
| UserMapper.selectManagerByName| 语法| ```public selectManagerByName(String name)```|
|| 前置条件 | 相同username的经理PO在数据库中存在|
|| 后置条件 | 返回一个经理PO|
| UserMapper.init| 语法| ```public void init() throws Exception```|
|| 前置条件 | 无|
|| 后置条件 | 初始化持久化数据库|
| UserMapper.finish| 语法| ```public void finish() throws Exception```|
|| 前置条件 | 无|
|| 后置条件 | 结束持久化数据库的使用|

RoleMapper的接口规范如下表所示

|提供的服务（供接口）|||
|-|-|-|
| RoleMapper.insertSelective| 语法| ```public int insertSelective(Role record)```|
|| 前置条件 | 相同id的PO在数据库中不存在|
|| 后置条件 | 在数据库中增加一个PO记录|
| RoleMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Integer id)```|
|| 前置条件 | 相同id的PO在数据库中存在|
|| 后置条件 | 在数据库中删除一个PO记录|
| RoleMapper.updateByPrimaryKeySelective| 语法| ```public int updateByPrimaryKeySelective(Role record)```|
|| 前置条件 | 相同id的PO在数据库中存在|
|| 后置条件 | 在数据库中更新一个PO记录|
|RoleMapper.selectByPrimaryKey| 语法| ```public Role selectByPrimaryKey(Integer id)```|
|| 前置条件 | 相同id的PO在数据库中存在|
|| 后置条件 | 返回一个PO记录|
|RoleMapper.selectRoleByName| 语法| ```public Role selectRoleByName(String role_name)```|
|| 前置条件 | 相同RoleName的PO在数据库中存在|
|| 后置条件 | 返回一个PO记录|

UserHasRoleMapper的接口规范如下表所示

|提供的服务（供接口）|||
|-|-|-|
| UserHasRoleMapper.insertSelective| 语法| ```public int insertSelective(UserHasRoleKey record)```|
|| 前置条件 | 相同UserID的PO在数据库中不存在|
|| 后置条件 | 在数据库中增加一个PO记录|
| UserHasRoleMapper.deleteByUserID| 语法| ```public int deleteByUserID(int userID)```|
|| 前置条件 | 相同UserID的PO在数据库中存在|
|| 后置条件 | 在数据库中删除一个PO记录|
| UserHasRoleMapper.updateByUserID| 语法| ```public int updateByUserID(UserHasRoleKey record)```|
|| 前置条件 | 相同UserID的PO在数据库中存在|
|| 后置条件 | 在数据库中更新一个PO记录|
|UserHasRoleMapper.selectByUserID| 语法| ```public UserHasRoleKey selectByUserID(int userID)```|
|| 前置条件 | 相同UserID的PO在数据库中存在|
|| 后置条件 | 返回一个PO记录|

#### 4.2.2 moviedataservice 模块

##### 4.2.2.1 模块概述

moviedataservice模块的职责参见体系结构文档。

##### 4.2.2.2 模块内部类的接口规范

MovieMapper的接口规范如下表所示

|提供的服务（供接口）|||
|-|-|-|
|MovieMapper.insertSelective|语法|```public int insertSelective(Movie record)```|
||前置条件|无|
||后置条件|插入一个MoviePO对象|
|MovieMapper.deleteByPrimaryKey|语法|```public int deleteByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|删除一个MoviePO对象|
|MovieMapper.updateByPrimaryKeySelective|语法|```public int updateByPrimaryKeySelective(Movie record)```|
||前置条件|无|
||后置条件|更新一个MoviePO对象|
|MovieMapper.selectAll|语法|```public List<Movie> selectAll()```|
||前置条件|无|
||后置条件|获取所有的MoviePO|
|MovieMapper.query|语法|```public List<Movie> query(String query)```|
||前置条件|无|
||后置条件|获取符合参数条件的MoviePO|
|MovieMapper.|语法|```public ```|
||前置条件|无|
||后置条件||
|MovieMapper.init|语法|```public void init() throws Exception```|
||前置条件|无|
||后置条件|初始化持久化数据库|
|MovieMapper.finish|语法|```public void finish() throws Exception```|
||前置条件|无|
||后置条件|结束持久化数据库的引用|

MovieLikeMapper的接口规范如下表所示

|提供的服务（供接口）|||
|-|-|-|
|MovieLikeMapper.insertSelective|语法|```public int insertSelective(MovieLike record)```|
||前置条件|无|
||后置条件|插入一个MovieLikePO对象|
|MovieLikeMapper.deleteByUserAndMovie|语法|```public int deleteByUserAndMovie(MovieLike record)```|
||前置条件|无|
||后置条件|删除一个MovieLikePO对象|
|MovieLikeMapper.selectByUserAndMovie|语法|```public MovieLike selectByUserAndMovie(MovieLike record)```|
||前置条件|无|
||后置条件|获取符合条件的一个MovieLikePO对象|
|MovieLikeMapper.selectByMovieID|语法|```public List<MovieLike> selectByMovieID(int movieID)```|
||前置条件|无|
||后置条件|获取该电影的所有MovieLikePO对象|
|MovieLikeMapper.selectByMovieGroupByDate|语法|```public  List<Map<String, Object>> selectByMovieGroupByDate(int movieID)```|
||前置条件|无|
||后置条件|获取该电影的所有MovieLikePO对象和相应的日期|
|MovieLikeMapper.selectByUserID(int userID)|语法|```public List<MovieLike> selectByUserID(int userID)```|
||前置条件|无|
||后置条件|获取该用户的所有MovieLikePO对象|

#### 4.2.3 cinemadataservice 模块

##### 4.2.3.1 模块概述

cinemadataservice模块的职责参见体系结构文档。

##### 4.2.3.2 模块内部类的接口规范

HallMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|HallMapper.insertSelective|语法|```public int insertSelective(Hall record)```|
||前置条件|无|
||后置条件|插入一个HallPO|
|HallMapper.deleteByPrimaryKey|语法|```public int deleteByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|删除一个HallPO|
|HallMapper.updateByPrimaryKeySelective|语法|```public int updateByPrimaryKeySelective(Hall record)```|
||前置条件|无|
||后置条件|更新一个HallPO|
|HallMapper.selectByPrimaryKey|语法|```public Hall selectByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|获得一个HallPO|
|HallMapper.selectAll|语法|```public List<Hall> selectAll()```|
||前置条件|无|
||后置条件|获得所有的HallPO|
| HallMapper.init   | 语法| ```public void init() throws Exception```|
|| 前置条件 | 无|
|| 后置条件 | 初始化持久化数据库|
| HallMapper.finish | 语法| ```public void finish() throws Exception```|
|| 前置条件 | 无|
|| 后置条件 | 结束持久化数据库的使用|

SeatMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|SeatMapper.insertSelective|语法|```public int insertSelective(Seat record)```|
||前置条件|无|
||后置条件|插入一个SeatPO|
|SeatMapper.deleteByPrimaryKey|语法|```public int deleteByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|删除一个SeatPO|
|SeatMapper.updateByPrimaryKeySelective|语法|```public int updateByPrimaryKeySelective(Seat record)```|
||前置条件|无|
||后置条件|更新一个SeatPO|
|SeatMapper.selectByPrimaryKey|语法|```public Seat selectByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|获得一个SeatPO|
|SeatMapper.selectAll|语法|```public List<Seat> selectAll()```|
||前置条件|无|
||后置条件|获得所有的SeatPO|
|SeatMapper.selectByHallID|语法|```public List<Seat> selectByHallID(int hallID)```|
||前置条件|无|
||后置条件|获得该影厅所有的SeatPO|
|SeatMapper.deleteByHallID|语法|```public int deleteByHallID(int hallID)```|
||前置条件|无|
||后置条件|删除该影厅所有的SeatPO|

ArrangementMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|ArrangementMapper.insertSelective|语法|```public int insertSelective(Arrangement record)```|
||前置条件|无|
||后置条件|插入一个ArrangementPO|
|ArrangementMapper.deleteByPrimaryKey|语法|```public int deleteByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|删除一个ArrangementPO|
|ArrangementMapper.updateByPrimaryKeySelective|语法|```public int updateByPrimaryKeySelective(Arrangement record)```|
||前置条件|无|
||后置条件|更新一个ArrangementPO|
|ArrangementMapper.selectByPrimaryKey|语法|```public Arrangement selectByPrimaryKey(Integer id)```|
||前置条件|无|
||后置条件|获得一个ArrangementPO|
|ArrangementMapper.selectByMovieID|语法|```public List<Arrangement> selectByMovieID(int movieID)```|
||前置条件|无|
||后置条件|获得该电影所有的ArrangementPO|
|ArrangementMapper.selectByHallIDAndStartDate|语法|```public List<Arrangement> selectByHallIDAndStartDate(int hallID,Date startDate,int duration)```|
||前置条件|无|
||后置条件|获得该影厅StartDate后duration天内所有的ArrangementPO|
|ArrangementMapper.selectByHallIDAndCurrentTime|语法|```public List<Arrangement> selectByHallIDAndCurrentTime(int hallID,Date currentTime)```|
||前置条件|无|
||后置条件|获得该影厅currentTime后所有的ArrangementPO|
|ArrangementMapper.selectByDay|语法|```public List<Arrangement> selectByDay(Date startDay,Date endDay)```|
||前置条件|无|
||后置条件|获得该时间段内所有的ArrangementPO|

ArrangementSeatMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|ArrangementSeatMapper.insertSelective|语法|```public int insertSelective(ArrangementSeat record)```|
||前置条件|无|
||后置条件|插入一个ArrangementSeatPO|
|ArrangementSeatMapper.delete|语法|```public int delete(ArrangementSeat record)```|
||前置条件|无|
||后置条件|删除一个ArrangementSeatPO|
|ArrangementSeatMapper.updateSeatStatus|语法|```public int updateSeatStatus(ArrangementSeat record)```|
||前置条件|无|
||后置条件|更新一个ArrangementSeatPO里Seat的状态|
|ArrangementSeatMapper.select|语法|```public ArrangementSeat select(ArrangementSeat record)```|
||前置条件|无|
||后置条件|获得一个ArrangementSeatPO|
|ArrangementSeatSeatMapper.selectByArrangementID|语法|```public List<ArrangementSeat> selectByArrangementID(int arrangementId)```|
||前置条件|无|
||后置条件|获得该场排片的所有ArrangementSeatPO|

#### 4.2.4 vipdataservice 模块

##### 4.2.4.1 模块概述

vipdataservice模块的职责参见体系结构文档。

##### 4.2.4.2 模块内部类的接口规范

VipcardMapper的接口规范如下表所示

| 提供的服务（供接口）                      |          |                                                              |
| ----------------------------------------- | -------- | ------------------------------------------------------------ |
| VipcardMapper.insertSelective             | 语法     | ```public int insertSelective(Vipcard record)```             |
|                                           | 前置条件 | 无                                                           |
|                                           | 后置条件 | 插入一个VIPCardPO                                            |
| VipcardMapper.deleteByPrimaryKey          | 语法     | ```public int deleteByPrimaryKey(Integer userId)```          |
|                                           | 前置条件 | 无                                                           |
|                                           | 后置条件 | 删除一个VIPCardPO                                            |
| VipcardMapper.updateByPrimaryKeySelective | 语法     | ```public int updateByPrimaryKeySelective(Vipcard record)``` |
|                                           | 前置条件 | 无                                                           |
|                                           | 后置条件 | 更新一个VIPCardPO                                            |
| VipcardMapper.selectByPrimaryKey          | 语法     | ```public Vipcard selectByPrimaryKey(Integer userId)```      |
|                                           | 前置条件 | 无                                                           |
|                                           | 后置条件 | 获得一个VIPCardPO                                            |
| VipcardMapper.selectAll                   | 语法     | ```public List<Vipcard> selectAll()```                       |
|                                           | 前置条件 | 无                                                           |
|                                           | 后置条件 | 获取所有VIPCardPO                                            |

TradeRecordMapper的接口规范如下表所示

| 提供的服务（供接口）                 |          |                                                              |
| ------------------------------------ | -------- | ------------------------------------------------------------ |
| TradeRecordMapper.insertSelective    | 语法     | ```public int insertSelective(TradeRecord record)```         |
|                                      | 前置条件 | 无                                                           |
|                                      | 后置条件 | 插入一个TradeRecordPO                                        |
| TradeRecordMapper.deleteByPrimaryKey | 语法     | ```public int deleteByPrimaryKey(Integer id)```              |
|                                      | 前置条件 | 无                                                           |
|                                      | 后置条件 | 删除一个TradeRecordPO                                        |
| TradeRecordMapper.selectByPrimaryKey | 语法     | ```public TradeRecord selectByPrimaryKey(Integer id)```      |
|                                      | 前置条件 | 无                                                           |
|                                      | 后置条件 | 获得一个TradeRecordPO                                        |
| TradeRecordMapper.selectByUserID     | 语法     | ```public List<TradeRecord> selectByUserID(Integer userID)``` |
|                                      | 前置条件 | 无                                                           |
|                                      | 后置条件 | 获得该用户所有的TradeRecordPO                                |

VipcardRechargeReductionMapper的接口规范如下表所示

| 提供的服务（供接口）                                       |          |                                                              |
| ---------------------------------------------------------- | -------- | ------------------------------------------------------------ |
| VipcardRechargeReductionMapper.insertSelective             | 语法     | ```public int insertSelective(VipcardRechargeReduction record)``` |
|                                                            | 前置条件 | 无                                                           |
|                                                            | 后置条件 | 插入一个VipcardRechargeReductionPO                           |
| VipcardRechargeReductionMapper.deleteByPrimaryKey          | 语法     | ```public int deleteByPrimaryKey(Integer targetAmount)```    |
|                                                            | 前置条件 | 无                                                           |
|                                                            | 后置条件 | 删除一个VipcardRechargeReductionPO                           |
| VipcardRechargeReductionMapper.updateByPrimaryKeySelective | 语法     | ```public  int updateByPrimaryKeySelective(VipcardRechargeReduction record)``` |
|                                                            | 前置条件 | 无                                                           |
|                                                            | 后置条件 | 更新一个VipcardRechargeReductionPO                           |
| VipcardRechargeReductionMapper.selectByPrimaryKey          | 语法     | ```public List<VipcardRechargeReduction> selectByPrimaryKey(Integer targetAmount)``` |
|                                                            | 前置条件 | 无                                                           |
|                                                            | 后置条件 | 获得一个或全部VipcardRechargeReductionPO                     |
| VipcardRechargeReductionMapper.selectByAmount              | 语法     | ```public VipcardRechargeReduction selectByAmount( Float amount)``` |
|                                                            | 前置条件 | 无                                                           |
|                                                            | 后置条件 | 获得最适合该Amount的一个VipcardRechargeReductionPO           |

#### 4.2.5 saledataservice 模块

##### 4.2.5.1 模块概述

saledataservice模块的职责参见体系结构文档。

##### 4.2.5.2 模块内部类的接口规范

PromotionMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|PromotionMapper.insertSelective| 语法| ```public int insertSelective(Promotion record)```|
|| 前置条件 | 无|
|| 后置条件 | 插入一个PromotionPO|
|PromotionMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 删除一个PromotionPO|
|PromotionMapper.updateByPrimaryKeySelective(| 语法| ```public int updateByPrimaryKeySelective(Promotion record)```|
|| 前置条件 | 无|
|| 后置条件 | 更新一个PromotionPO|
|PromotionMapper.selectByPrimaryKey| 语法| ```public Promotion selectByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 获得一个PromotionPO|
|PromotionMapper.selectAll| 语法| ```public List<Promotion> selectAll()```|
|| 前置条件 | 无|
|| 后置条件 | 获得所有的PromotionPO|
| PromotionMapper.init| 语法| ```public void init() throws Exception```|
|| 前置条件 | 无|
|| 后置条件 | 初始化持久化数据库|
| PromotionMapper.finish| 语法| ```public void finish() throws Exception```|
|| 前置条件 | 无|
|| 后置条件 | 结束持久化数据库的使用|

PromotionHasMovieMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|PromotionHasMovieMapper.insertSelective| 语法| ```public int insertSelective(PromotionHasMovie record)```|
|| 前置条件 | 无|
|| 后置条件 | 插入一个PromotionHasMoviePO|
|PromotionHasMovieMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(PromotionHasMovie key)```|
|| 前置条件 | 无|
|| 后置条件 | 删除一个PromotionHasMoviePO|
|PromotionHasMovieMapper.selectByPromotionID| 语法| ```public List<PromotionHasMovie> selectByPromotionID(int promotionID)```|
|| 前置条件 | 无|
|| 后置条件 | 返回包含该PromotionID的所有PromotionHasMoviePO|
|PromotionHasMovieMapper.selectByMovieID| 语法| ```public List<PromotionHasMovie> selectByMovieID(Integer movieID)```|
|| 前置条件 | 无|
|| 后置条件 |返回包含该MovieID的所有PromotionHasMoviePO|

CouponMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|CouponMapper.insertSelective| 语法| ```public int insertSelective(Coupon record)```|
|| 前置条件 | 无|
|| 后置条件 | 插入一个CouponPO|
|CouponMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 删除一个CouponPO|
|CouponMapper.updateByPrimaryKeySelective| 语法| ```public int updateByPrimaryKeySelective(Coupon record)```|
|| 前置条件 | 无|
|| 后置条件 | 更新一个CouponPO|
|CouponMapper.selectByPrimaryKey| 语法| ```public Coupon selectByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 获得一个CouponPO|
|CouponMapper.selectByUserID| 语法| ```public List<Coupon> selectByUserID(int userID)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该用户的所有CouponPO|

RefundStrategyMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|RefundStrategyMapper.insertSelective| 语法| ```public int insertSelective(RefundStrategy record)```|
|| 前置条件 | 无|
|| 后置条件 | 插入一个RefundStrategyPO|
|RefundStrategyMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 删除一个RefundStrategyPO|
|RefundStrategyMapper.updateByPrimaryKeySelective| 语法| ```public int updateByPrimaryKeySelective(RefundStrategy record)```|
|| 前置条件 | 无|
|| 后置条件 | 更新一个RefundStrategyPO|
|RefundStrategyMapper.selectByPrimaryKey| 语法| ```public RefundStrategy selectByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 获得一个RefundStrategyPO|
|RefundStrategyMapper.selectAll| 语法| ```public  List<RefundStrategy> selectAll()```|
|| 前置条件 | 无|
|| 后置条件 | 获得所有的RefundStrategyPO|
|RefundStrategyMapper.selectByDay| 语法| ```public RefundStrategy selectByDay(long dayToCome)```|
|| 前置条件 | 无|
|| 后置条件 | 通过天数获得最适合的RefundStrategyPO|

TicketsMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|TicketsMapper.insertSelective| 语法| ```public int insertSelective(Ticket record)```|
|| 前置条件 | 无|
|| 后置条件 | 插入一个TicketPO|
|TicketsMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 删除一个TicketPO|
|TicketsMapper.updateByPrimaryKeySelective| 语法| ```public int updateByPrimaryKeySelective(Ticket record)```|
|| 前置条件 | 无|
|| 后置条件 | 更新一个TicketPO|
|TicketsMapper.selectByPrimaryKey| 语法| ```public Ticket selectByPrimaryKey(Integer id)```|
|| 前置条件 | 无|
|| 后置条件 | 获得一个TicketPO|
|TicketsMapper.selectByUserID| 语法| ```public List<Ticket> selectByUserID(int userID)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该用户的所有TicketPO|
|TicketsMapper.selectByOrderID| 语法| ```public List<Ticket> selectByOrderID(long orderID)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该订单的所有TicketPO|
|TicketsMapper.selectByMovieID| 语法| ```public List<Ticket> selectByMovieID(int movieID)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该电影的所有TicketPO|
|TicketsMapper.selectByArrangementID| 语法| ```public List<Ticket> selectByArrangementID(int arrangementID)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该场排片的所有TicketPO|
|TicketsMapper.selectByDate| 语法| ```public List<Ticket> selectByDate(Date startDate, Date endDate)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该时间段内的所有TicketPO|

OrderMapper的接口规范如下表所示

| 提供的服务（供接口）|||
| - | - | - |
|OrderMapper.insertSelective| 语法| ```public int insertSelective(Order record)```|
|| 前置条件 | 无|
|| 后置条件 | 插入一个OrderPO|
|OrderMapper.deleteByPrimaryKey| 语法| ```public int deleteByPrimaryKey(Long id)```|
|| 前置条件 | 无|
|| 后置条件 | 删除一个OrderPO|
|OrderMapper.updateByPrimaryKeySelective| 语法| ```public int updateByPrimaryKeySelective(Order record)```|
|| 前置条件 | 无|
|| 后置条件 | 更新一个OrderPO|
|OrderMapper.selectByPrimaryKey| 语法| ```public Order selectByPrimaryKey(Long id)```|
|| 前置条件 | 无|
|| 后置条件 | 获得一个OrderPO|
|OrderMapper.selectByUserAndOrderID| 语法| ```List<Order> selectByUserAndOrderID(int userID, long orderID)```|
|| 前置条件 | 无|
|| 后置条件 | 获得该用户的这个OrderPO|

### 4.3 展示层的分解

#### 4.3.1 展示层的接口规范

| 接口名 |||
| - | :- |-|
| MainFrame.loginPage |语法|```GET /login```|
||前置条件|无|
||后置条件|进入登录界面|
| MainFrame.login |语法|```POST /login```|
||前置条件|用户未登录，password符合输入规范|
||后置条件|查找是否存在相应的User，根据输入的password返回登录验证的结果，跳转至对应的Frame|
|MainFrame.registerPage|语法|```GET /register```|
||前置条件|无|
||后置条件|进入注册界面|
|MainFrame.register|语法|```POST /register```|
||前置条件|无|
||后置条件|查找username没有重复,用户信息符合规范，返回注册结果|
|/*Frame.logout|语法|```POST /logout```|
||前置条件|用户已登录|
||后置条件|无|
|UserFrame.movieDetail|语法|```GET /user/movie/{movieId}```|
||前置条件|用户已登录|
||后置条件|跳转至对应电影详细页面|
|UserFrame.movies|语法|```GET /user/movie```|
||前置条件|用户已登录|
||后置条件|跳转至所有上架电影页面|
|UserFrame.search|语法|```GET /user/movie/search```|
||前置条件|用户已登录|
||后置条件|跳转至所有符合搜索条件的电影界面|
|UserFrame.movieArrangement|语法|```GET /user/arrangement/get```|
||前置条件|用户已登录|
||后置条件|跳转至电影排片界面|
|UserFrame.arrangement|语法|```GET /user/seat/get```|
||前置条件|用户已登录|
||后置条件|跳转至某场排片的详情界面|
|UserFrame.lockSeats|语法|```POST /user/ticket/lockSeats/{arrangementId}```|
||前置条件|用户已登录且在该场次没有未完成订单|
||后置条件|生成订单，跳转至支付界面|
|UserForm.payByVIPCard|语法|```POST /user/vip/pay/{orderID}```|
||前置条件|用户可以支付这个订单|
||后置条件|系统处理用户的支付|
|UserForm.payByAlipay|语法|```POST /user/alipay/pay/{orderID}```|
||前置条件|用户可以支付这个订单|
||后置条件|系统请求第三方支付，等待第三方支付的结果|
|UserForm.refund|语法|```POST /user/ticket/refund```|
||前置条件|用户可以退这张票|
||后置条件|系统为用户处理退票|
|UserFrame.buyPage|语法|```GET /user/buy```|
||前置条件|用户已登录|
||后置条件|跳转至购票界面|
|UserForm.cardPocket|语法|```GET /user/cardPocket```|
||前置条件|用户已登录|
||后置条件|跳转至卡包界面|
|UserForm.buyCard|语法|```POST /user/vip/card/add```|
||前置条件|用户已登录且没有会员卡|
||后置条件|系统处理用户的购卡|
|UserForm.deposit|语法|```POST /user/vip/deposit```|
||前置条件|用户已登录且已经有会员卡|
||后置条件|系统处理用户的充值|
|UserForm.consumeRecordPage|语法|```GET /user/consumeRecord```|
||前置条件|用户已登录|
||后置条件|跳转至消费记录界面|
|UserForm.purchaseRecordPage|语法|```GET /user/purchaseRecord```|
||前置条件|用户已登录|
||后置条件|跳转至消费记录界面|
|UserForm.RechargeRecord|语法|```GET /user/rechargeRecord```|
||前置条件|用户已登录|
||后置条件|跳转至充值记录界面|
|UserFrame.index|语法|```GET /user/home```|
||前置条件|用户已登录|
||后置条件|跳转至观众主界面|
|UserFrame.like|语法|```POST /user/movie/like/{movie_id}```|
||前置条件|用户已登录|
||后置条件|上传点击想看的信息，显示点击想看操作的结果|
|UserFrame.unlike|语法|```POST /user/movie/unlike/{movie_id}```|
||前置条件|用户已登录|
||后置条件|上传点击想看的信息，显示点击想看操作的结果|
|UserFrame.vipcard|语法|```GET /user/vip/card/get```|
||前置条件|用户已登录|
||后置条件|跳转至观众会员卡信息界面|
|UserFrame.purchaseVip|语法|```GET /user/vip/card/add```|
||前置条件|用户已登录|
||后置条件|跳转至观众会员卡购买界面|
|UserFrame.chargeVip|语法|```GET /user/vip/deposit```|
||前置条件|用户已登录，且持有会员卡|
||后置条件|跳转至观众会员卡充值界面|
|UserFrame.buyTicket|语法|```GET /user/seat/get```|
||前置条件|用户已登录|
||后置条件|跳转至选座界面|
|UserFrame.tickets|语法|```GET /user/purchaseRecord```|
||前置条件|用户已登录|
||后置条件|跳转至已购电影票界面|
|ManageFrame.index|语法|```GET /manage```|
||前置条件|管理员已登录|
||后置调价|跳转至管理员主界面|
|ManageFrame.releaseInit|语法|```GET /manage/movie```|
||前置条件|管理员已登录|
||后置条件|跳转至电影管理界面|
|ManageFrame.release|语法|```POST /manage/add```|
||前置条件|管理员已登录，输入了符合规范的影片信息|
||后置条件|上传电影信息，显示上架结果|
|ManageFrame.modify|语法|```POST /manage/modify```|
||前置条件|管理员已登录，输入了符合规范的影片信息|
||后置条件|上传电影信息，显示修改结果|
|ManageFrame.release|语法|```POST /manage/remove```|
||前置条件|管理员已登录，电影存在|
||后置条件|显示下架结果|
|ManageFrame.statistics|语法|```GET /manage/statistics```|
||前置条件|管理员或影院员工已登录|
||后置条件|跳转至电影统计界面|
|ManageFrame.manageArrangementInit|语法|```GET /manage/arrangement```|
||前置条件|影院员工已登录|
||后置条件|跳转至排片管理的界面|
|ManageFrame.addArrangement|语法|```POST /manage/arrangement/add```|
||前置条件|影院员工已登录|
||后置条件|上传排片信息，显示排片结果|
|ManageFrame.modifyArrangement|语法|```POST /manage/arrangement/modify```|
||前置条件|影院员工已登录，存在目标排片|
||后置条件|上传排片信息，显示修改排片结果|
|ManageFrame.removeArrangement|语法|```POST /manage/arrangement/remove```|
||前置条件|影院员工已登录，存在目标排片|
||后置条件|显示删除排片结果|
|AdminFrame.discountInit|语法|```GET /admin/promotion/get```|
||前置条件|影院管理员已登录|
||后置条件|跳转至优惠活动管理界面|
|AdminFrame.releaseDiscount|语法|```POST /admin/promotion/add```|
||前置条件|影院管理员已登录|
||后置条件|显示发布优惠活动的结果|
|AdminFrame.addRefundStrategy|语法|```POST /admin/refund/add```|
||前置条件|影院管理员已登录|
||后置条件|显示发布退票策略的结果|
|AdminFrame.modifyRefundStrategy|语法|```POST /admin/refund/modify```|
||前置条件|影院管理员已登录，退票策略存在|
||后置条件|显示修改退票策略的结果|
|AdminFrame.addHall|语法|```POST /admin/hall/add```|
||前置条件|影院管理员已登录|
||后置条件|显示新增影厅的结果|
|AdminFrame.modifyHall|语法|```POST /admin/hall/modify```|
||前置条件|影院管理员已登录，影厅存在|
||后置条件|显示修改影厅的结果|
|AdminFrame.addReduction|语法|```POST /admin/vip/reduction/add```|
||前置条件|影院管理员已登录|
||后置条件|显示新增充值优惠的结果|
|AdminFrame.modifyReduction|语法|```POST /admin/vip/reduction/modify```|
||前置条件|影院管理员已登录，充值优惠存在|
||后置条件|显示修改充值优惠的结果|
|AdminFrame.addReduction|语法|```POST /admin/vip/reduction/delete```|
||前置条件|影院管理员已登录，充值优惠存在|
||后置条件|显示删除充值优惠的结果|
|AdminFrame.presentCoupon|语法|```POST /admin/vip/presentCoupon```|
||前置条件|影院管理员已登录|
||后置条件|显示赠送优惠券的结果|
|RootFrame.addStaff|语法|```POST /root/addStaff```|
||前置条件|影院管理员已登录|
||后置条件|显示新增员工的结果|
|RootFrame.removeStaff|语法|```POST /root/removeStaff```|
||前置条件|影院管理员已登录，存在目标员工|
||后置条件|显示删除员工的结果|
|RootFrame.changeStaffRole|语法|```POST /root/changeRole```|
||前置条件|影院管理员已登录，存在目标员工|
||后置条件|显示修改员工角色的结果|


## 5 依赖视角

- 下图是客户端各自的包之间的依赖视角

![客户端各自的包之间的依赖视角](https://github.com/Translucentwall/UMLImage/blob/master/docTask3/clientSDK.jpg?raw=true)

- 下图是服务器端各自的包之间的依赖视角

![服务器端各自的包之间的依赖视角](https://github.com/Translucentwall/UMLImage/blob/master/docTask3/serverSDK.jpg?raw=true)

- 下图表达了我们对评审我组文档的同学由衷的感谢。ありがとうございました。

![彩蛋](http://gitlab.yangshan.tech/TeamNameCannotBeEmpty/4eb4d979b8ac4b79b3b4fb93a2e9aaba/raw/master/pic/005PEfhzly1fxteug3ighj30as0a0gme.jpg)
